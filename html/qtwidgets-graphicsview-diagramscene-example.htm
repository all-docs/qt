<html lang="en"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Diagram Scene Example | Qt Widgets</title>
<link rel="canonical" href="https://doc.qt.io/qt-6/qtwidgets-graphicsview-diagramscene-example.html">
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <!-- Google Tag Manager -->
    
  <!-- End Google Tag Manager -->
  
  
</head>
<body class="qt-design-system" style="background:var(--content-bg-color)" onload="prettyPrint()">

<div data-global-resource-path="qt-design-system/components/b-sidebar.html">
    <div class="b-sidebar b-sidebar--full-width">
        
        <div class="b-sidebar__content">
            <div class="b-sidebar__topbar" data-margin-bottom="sm">
                <div class="b-topbar">
                                        <div class="b-topbar__breadcrump" translate="no">
                        <ul class="c-breadcrump">
                            <li><a href="./index.htm" translate="no">Qt 5.15</a></li>
                            <li><a href="./qtwidgets-index.htm" translate="no">Qt Widgets</a></li>
                            <li><a>Diagram Scene Example</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="b-sidebar__content__wrapper">
                <article class="b-sidebar__content__left">
                    <div class="context mainContent" style="margin: 0;padding: 0; background: 0;">
                    

<div class="context">
<h1 class="title">Diagram Scene Example</h1>
<span class="subtitle"></span>
<!-- $$$graphicsview/diagramscene-brief -->
<p>Demonstrate how to use the Graphics View framework.</p>
<!-- @@@graphicsview/diagramscene -->
<!-- $$$graphicsview/diagramscene-description -->
<div class="descr"> <a name="details"></a>
<p class="centerAlign"><img alt="" src="./images/diagramscene.png"></p><p>The Diagram Scene example is an application in which you can create a flowchart diagram. It is possible to add flowchart shapes and text and connect the shapes by arrows as shown in the image above. The shapes, arrows, and text can be given different colors, and it is possible to change the font, style, and underline of the text.</p>
<p>The Qt graphics view framework is designed to manage and display custom 2D graphics items. The main classes of the framework are <a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a>, <a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a> and <a href="./qgraphicsview.htm" translate="no">QGraphicsView</a>. The graphics scene manages the items and provides a surface for them. <a href="./qgraphicsview.htm" translate="no">QGraphicsView</a> is a widget that is used to render a scene on the screen. See the <a href="./graphicsview.htm" translate="no">Graphics View Framework</a> for a more detailed description of the framework.</p>
<p>In this example we show how to create such custom graphics scenes and items by implementing classes that inherit <a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a> and <a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a>.</p>
<p>In particular we show how to:</p>
<ul>
<li>Create custom graphics items.</li>
<li>Handle mouse events and movement of items.</li>
<li>Implement a graphics scene that can manage our custom items.</li>
<li>Custom painting of items.</li>
<li>Create a movable and editable text item.</li>
</ul>
<p>The example consists of the following classes:</p>
<ul>
<li><code translate="no">MainWindow</code> creates the widgets and display them in a <a href="./qmainwindow.htm" translate="no">QMainWindow</a>. It also manages the interaction between the widgets and the graphics scene, view and items.</li>
<li><code translate="no">DiagramItem</code> inherits <a href="./qgraphicspolygonitem.htm" translate="no">QGraphicsPolygonItem</a> and represents a flowchart shape.</li>
<li><code translate="no">TextDiagramItem</code> inherits <a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a> and represents text items in the diagram. The class adds support for moving the item with the mouse, which is not supported by <a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a>.</li>
<li><code translate="no">Arrow</code> inherits <a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a> and is an arrow that connect two DiagramItems.</li>
<li><code translate="no">DiagramScene</code> inherits QGraphicsDiagramScene and provides support for <code translate="no">DiagramItem</code>, <code translate="no">Arrow</code> and <code translate="no">DiagramTextItem</code> (In addition to the support already handled by <a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a>).</li>
</ul>
<a name="mainwindow-class-definition"></a>
<h4 id="mainwindow-class-definition">MainWindow Class Definition<a class="plink" href="#mainwindow-class-definition" title="Direct link to this headline"></a></h4>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="keyword">class</span> MainWindow : <span class="keyword">public</span> <span class="type"><a href="./qmainwindow.htm" translate="no">QMainWindow</a></span>
{
    Q_OBJECT

<span class="keyword">public</span>:
   MainWindow();

<span class="keyword">private</span> <span class="keyword">slots</span>:
    <span class="type">void</span> backgroundButtonGroupClicked(<span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span>button);
    <span class="type">void</span> buttonGroupClicked(<span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span>button);
    <span class="type">void</span> deleteItem();
    <span class="type">void</span> pointerGroupClicked();
    <span class="type">void</span> bringToFront();
    <span class="type">void</span> sendToBack();
    <span class="type">void</span> itemInserted(DiagramItem <span class="operator">*</span>item);
    <span class="type">void</span> textInserted(<span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span> <span class="operator">*</span>item);
    <span class="type">void</span> currentFontChanged(<span class="keyword">const</span> <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> <span class="operator">&amp;</span>font);
    <span class="type">void</span> fontSizeChanged(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>size);
    <span class="type">void</span> sceneScaleChanged(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>scale);
    <span class="type">void</span> textColorChanged();
    <span class="type">void</span> itemColorChanged();
    <span class="type">void</span> lineColorChanged();
    <span class="type">void</span> textButtonTriggered();
    <span class="type">void</span> fillButtonTriggered();
    <span class="type">void</span> lineButtonTriggered();
    <span class="type">void</span> handleFontChange();
    <span class="type">void</span> itemSelected(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item);
    <span class="type">void</span> about();

<span class="keyword">private</span>:
    <span class="type">void</span> createToolBox();
    <span class="type">void</span> createActions();
    <span class="type">void</span> createMenus();
    <span class="type">void</span> createToolbars();
    <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>createBackgroundCellWidget(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>text<span class="operator">,</span>
                                        <span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>image);
    <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>createCellWidget(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>text<span class="operator">,</span>
                              DiagramItem<span class="operator">::</span>DiagramType type);
    <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>createColorMenu(<span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>slot<span class="operator">,</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> defaultColor);
    <span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span> createColorToolButtonIcon(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>image<span class="operator">,</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> color);
    <span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span> createColorIcon(<span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> color);

    DiagramScene <span class="operator">*</span>scene;
    <span class="type"><a href="./qgraphicsview.htm" translate="no">QGraphicsView</a></span> <span class="operator">*</span>view;

    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>exitAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>addAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>deleteAction;

    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>toFrontAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>sendBackAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>aboutAction;

    <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>fileMenu;
    <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>itemMenu;
    <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>aboutMenu;

    <span class="type"><a href="./qtoolbar.htm" translate="no">QToolBar</a></span> <span class="operator">*</span>textToolBar;
    <span class="type"><a href="./qtoolbar.htm" translate="no">QToolBar</a></span> <span class="operator">*</span>editToolBar;
    <span class="type"><a href="./qtoolbar.htm" translate="no">QToolBar</a></span> <span class="operator">*</span>colorToolBar;
    <span class="type"><a href="./qtoolbar.htm" translate="no">QToolBar</a></span> <span class="operator">*</span>pointerToolbar;

    <span class="type"><a href="./qcombobox.htm" translate="no">QComboBox</a></span> <span class="operator">*</span>sceneScaleCombo;
    <span class="type"><a href="./qcombobox.htm" translate="no">QComboBox</a></span> <span class="operator">*</span>itemColorCombo;
    <span class="type"><a href="./qcombobox.htm" translate="no">QComboBox</a></span> <span class="operator">*</span>textColorCombo;
    <span class="type"><a href="./qcombobox.htm" translate="no">QComboBox</a></span> <span class="operator">*</span>fontSizeCombo;
    <span class="type"><a href="./qfontcombobox.htm" translate="no">QFontComboBox</a></span> <span class="operator">*</span>fontCombo;

    <span class="type"><a href="./qtoolbox.htm" translate="no">QToolBox</a></span> <span class="operator">*</span>toolBox;
    <span class="type"><a href="./qbuttongroup.htm" translate="no">QButtonGroup</a></span> <span class="operator">*</span>buttonGroup;
    <span class="type"><a href="./qbuttongroup.htm" translate="no">QButtonGroup</a></span> <span class="operator">*</span>pointerTypeGroup;
    <span class="type"><a href="./qbuttongroup.htm" translate="no">QButtonGroup</a></span> <span class="operator">*</span>backgroundButtonGroup;
    <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span> <span class="operator">*</span>fontColorToolButton;
    <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span> <span class="operator">*</span>fillColorToolButton;
    <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span> <span class="operator">*</span>lineColorToolButton;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>boldAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>underlineAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>italicAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>textAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>fillAction;
    <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>lineAction;
};</pre></div>
<p>The <code translate="no">MainWindow</code> class creates and lays out the widgets in a <a href="./qmainwindow.htm" translate="no">QMainWindow</a>. The class forwards input from the widgets to the DiagramScene. It also updates its widgets when the diagram scene's text item changes, or a diagram item or a diagram text item is inserted into the scene.</p>
<p>The class also deletes items from the scene and handles the z-ordering, which decides the order in which items are drawn when they overlap each other.</p>
<a name="mainwindow-class-implementation"></a>
<h4 id="mainwindow-class-implementation">MainWindow Class Implementation<a class="plink" href="#mainwindow-class-implementation" title="Direct link to this headline"></a></h4>
<p>We start with a look at the constructor:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">MainWindow<span class="operator">::</span>MainWindow()
{
    createActions();
    createToolBox();
    createMenus();

    scene <span class="operator">=</span> <span class="keyword">new</span> DiagramScene(itemMenu<span class="operator">,</span> <span class="keyword">this</span>);
    scene<span class="operator">-</span><span class="operator">&gt;</span>setSceneRect(<span class="type"><a href="./qrectf.htm" translate="no">QRectF</a></span>(<span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">5000</span><span class="operator">,</span> <span class="number">5000</span>));
    connect(scene<span class="operator">,</span> <span class="operator">&amp;</span>DiagramScene<span class="operator">::</span>itemInserted<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>MainWindow<span class="operator">::</span>itemInserted);
    connect(scene<span class="operator">,</span> <span class="operator">&amp;</span>DiagramScene<span class="operator">::</span>textInserted<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>MainWindow<span class="operator">::</span>textInserted);
    connect(scene<span class="operator">,</span> <span class="operator">&amp;</span>DiagramScene<span class="operator">::</span>itemSelected<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>MainWindow<span class="operator">::</span>itemSelected);
    createToolbars();

    <span class="type"><a href="./qhboxlayout.htm" translate="no">QHBoxLayout</a></span> <span class="operator">*</span>layout <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qhboxlayout.htm" translate="no">QHBoxLayout</a></span>;
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(toolBox);
    view <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qgraphicsview.htm" translate="no">QGraphicsView</a></span>(scene);
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(view);

    <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>widget <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span>;
    widget<span class="operator">-</span><span class="operator">&gt;</span>setLayout(layout);

    setCentralWidget(widget);
    setWindowTitle(tr(<span class="string">"Diagramscene"</span>));
    setUnifiedTitleAndToolBarOnMac(<span class="keyword">true</span>);
}</pre></div>
<p>In the constructor we call methods to create the widgets and layouts of the example before we create the diagram scene. The toolbars must be created after the scene as they connect to its signals. We then lay the widgets out in the window.</p>
<p>We connect to the <code translate="no">itemInserted()</code> and <code translate="no">textInserted()</code> slots of the diagram scenes as we want to uncheck the buttons in the tool box when an item is inserted. When an item is selected in the scene we receive the <code translate="no">itemSelected()</code> signal. We use this to update the widgets that display font properties if the item selected is a <code translate="no">DiagramTextItem</code>.</p>
<p>The <code translate="no">createToolBox()</code> function creates and lays out the widgets of the <code translate="no">toolBox</code> <a href="./qtoolbox.htm" translate="no">QToolBox</a>. We will not examine it with a high level of detail as it does not deal with graphics framework specific functionality. Here is its implementation:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>createToolBox()
{
    buttonGroup <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qbuttongroup.htm" translate="no">QButtonGroup</a></span>(<span class="keyword">this</span>);
    buttonGroup<span class="operator">-</span><span class="operator">&gt;</span>setExclusive(<span class="keyword">false</span>);
    connect(buttonGroup<span class="operator">,</span> <span class="type">QOverload</span><span class="operator">&lt;</span><span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span><span class="operator">&gt;</span><span class="operator">::</span>of(<span class="operator">&amp;</span><span class="type"><a href="./qbuttongroup.htm" translate="no">QButtonGroup</a></span><span class="operator">::</span>buttonClicked)<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>MainWindow<span class="operator">::</span>buttonGroupClicked);
    <span class="type"><a href="./qgridlayout.htm" translate="no">QGridLayout</a></span> <span class="operator">*</span>layout <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qgridlayout.htm" translate="no">QGridLayout</a></span>;
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(createCellWidget(tr(<span class="string">"Conditional"</span>)<span class="operator">,</span> DiagramItem<span class="operator">::</span>Conditional)<span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">0</span>);
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(createCellWidget(tr(<span class="string">"Process"</span>)<span class="operator">,</span> DiagramItem<span class="operator">::</span>Step)<span class="operator">,</span><span class="number">0</span><span class="operator">,</span> <span class="number">1</span>);
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(createCellWidget(tr(<span class="string">"Input/Output"</span>)<span class="operator">,</span> DiagramItem<span class="operator">::</span>Io)<span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> <span class="number">0</span>);</pre></div>
<p>This part of the function sets up the tabbed widget item that contains the flowchart shapes. An exclusive <a href="./qbuttongroup.htm" translate="no">QButtonGroup</a> always keeps one button checked; we want the group to allow all buttons to be unchecked. We still use a button group since we can associate user data, which we use to store the diagram type, with each button. The <code translate="no">createCellWidget()</code> function sets up the buttons in the tabbed widget item and is examined later.</p>
<p>The buttons of the background tabbed widget item is set up in the same way, so we skip to the creation of the tool box:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    toolBox <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qtoolbox.htm" translate="no">QToolBox</a></span>;
    toolBox<span class="operator">-</span><span class="operator">&gt;</span>setSizePolicy(<span class="type"><a href="./qsizepolicy.htm" translate="no">QSizePolicy</a></span>(<span class="type"><a href="./qsizepolicy.htm" translate="no">QSizePolicy</a></span><span class="operator">::</span>Maximum<span class="operator">,</span> <span class="type"><a href="./qsizepolicy.htm" translate="no">QSizePolicy</a></span><span class="operator">::</span>Ignored));
    toolBox<span class="operator">-</span><span class="operator">&gt;</span>setMinimumWidth(itemWidget<span class="operator">-</span><span class="operator">&gt;</span>sizeHint()<span class="operator">.</span>width());
    toolBox<span class="operator">-</span><span class="operator">&gt;</span>addItem(itemWidget<span class="operator">,</span> tr(<span class="string">"Basic Flowchart Shapes"</span>));
    toolBox<span class="operator">-</span><span class="operator">&gt;</span>addItem(backgroundWidget<span class="operator">,</span> tr(<span class="string">"Backgrounds"</span>));
}</pre></div>
<p>We set the preferred size of the toolbox as its maximum. This way, more space is given to the graphics view.</p>
<p>Here is the <code translate="no">createActions()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>createActions()
{
    toFrontAction <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span>(<span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span>(<span class="string">":/images/bringtofront.png"</span>)<span class="operator">,</span>
                                tr(<span class="string">"Bring to &amp;Front"</span>)<span class="operator">,</span> <span class="keyword">this</span>);
    toFrontAction<span class="operator">-</span><span class="operator">&gt;</span>setShortcut(tr(<span class="string">"Ctrl+F"</span>));
    toFrontAction<span class="operator">-</span><span class="operator">&gt;</span>setStatusTip(tr(<span class="string">"Bring item to front"</span>));
    connect(toFrontAction<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="./qaction.htm" translate="no">QAction</a></span><span class="operator">::</span>triggered<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>MainWindow<span class="operator">::</span>bringToFront);</pre></div>
<p>We show an example of the creation of an action. The functionality the actions trigger is discussed in the slots we connect the actions to. You can see the <a href="./qtwidgets-mainwindows-application-example.htm" translate="no">application example</a> if you need a high-level introduction to actions.</p>
<p>The is the <code translate="no">createMenus()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>createMenus()
{
    fileMenu <span class="operator">=</span> menuBar()<span class="operator">-</span><span class="operator">&gt;</span>addMenu(tr(<span class="string">"&amp;File"</span>));
    fileMenu<span class="operator">-</span><span class="operator">&gt;</span>addAction(exitAction);

    itemMenu <span class="operator">=</span> menuBar()<span class="operator">-</span><span class="operator">&gt;</span>addMenu(tr(<span class="string">"&amp;Item"</span>));
    itemMenu<span class="operator">-</span><span class="operator">&gt;</span>addAction(deleteAction);
    itemMenu<span class="operator">-</span><span class="operator">&gt;</span>addSeparator();
    itemMenu<span class="operator">-</span><span class="operator">&gt;</span>addAction(toFrontAction);
    itemMenu<span class="operator">-</span><span class="operator">&gt;</span>addAction(sendBackAction);

    aboutMenu <span class="operator">=</span> menuBar()<span class="operator">-</span><span class="operator">&gt;</span>addMenu(tr(<span class="string">"&amp;Help"</span>));
    aboutMenu<span class="operator">-</span><span class="operator">&gt;</span>addAction(aboutAction);
}</pre></div>
<p>We create the three menus' of the example.</p>
<p>The <code translate="no">createToolbars()</code> function sets up the examples tool bars. The three <a href="./qtoolbutton.htm" translate="no">QToolButton</a>s in the <code translate="no">colorToolBar</code>, the <code translate="no">fontColorToolButton</code>, <code translate="no">fillColorToolButton</code>, and <code translate="no">lineColorToolButton</code>, are interesting as we create icons for them by drawing on a <a href="./qpixmap.htm" translate="no">QPixmap</a> with a <a href="./qpainter.htm" translate="no">QPainter</a>. We show how the <code translate="no">fillColorToolButton</code> is created. This button lets the user select a color for the diagram items.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>createToolbars()
{
    ...
    fillColorToolButton <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span>;
    fillColorToolButton<span class="operator">-</span><span class="operator">&gt;</span>setPopupMode(<span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span><span class="operator">::</span>MenuButtonPopup);
    fillColorToolButton<span class="operator">-</span><span class="operator">&gt;</span>setMenu(createColorMenu(SLOT(itemColorChanged())<span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>white));
    fillAction <span class="operator">=</span> fillColorToolButton<span class="operator">-</span><span class="operator">&gt;</span>menu()<span class="operator">-</span><span class="operator">&gt;</span>defaultAction();
    fillColorToolButton<span class="operator">-</span><span class="operator">&gt;</span>setIcon(createColorToolButtonIcon(
                                     <span class="string">":/images/floodfill.png"</span><span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>white));
    connect(fillColorToolButton<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span><span class="operator">::</span>clicked<span class="operator">,</span>
            <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>MainWindow<span class="operator">::</span>fillButtonTriggered);</pre></div>
<p>We set the menu of the tool button with <a href="./qtoolbutton.htm#setMenu" translate="no">setMenu()</a>. We need the <code translate="no">fillAction</code> <a href="./qaction.htm" translate="no">QAction</a> object to always be pointing to the selected action of the menu. The menu is created with the <code translate="no">createColorMenu()</code> function and, as we shall see later, contains one menu item for each color that the items can have. When the user presses the button, which trigger the <a href="./qabstractbutton.htm#clicked" translate="no">clicked()</a> signal, we can set the color of the selected item to the color of <code translate="no">fillAction</code>. It is with <code translate="no">createColorToolButtonIcon()</code> we create the icon for the button.</p>
<div class="pre"><pre class="cpp" translate="no">    ...
}</pre></div>
<p>Here is the <code translate="no">createBackgroundCellWidget()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>MainWindow<span class="operator">::</span>createBackgroundCellWidget(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>text<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>image)
{
    <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span> <span class="operator">*</span>button <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span>;
    button<span class="operator">-</span><span class="operator">&gt;</span>setText(text);
    button<span class="operator">-</span><span class="operator">&gt;</span>setIcon(<span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span>(image));
    button<span class="operator">-</span><span class="operator">&gt;</span>setIconSize(<span class="type"><a href="./qsize.htm" translate="no">QSize</a></span>(<span class="number">50</span><span class="operator">,</span> <span class="number">50</span>));
    button<span class="operator">-</span><span class="operator">&gt;</span>setCheckable(<span class="keyword">true</span>);
    backgroundButtonGroup<span class="operator">-</span><span class="operator">&gt;</span>addButton(button);

    <span class="type"><a href="./qgridlayout.htm" translate="no">QGridLayout</a></span> <span class="operator">*</span>layout <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qgridlayout.htm" translate="no">QGridLayout</a></span>;
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(button<span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>AlignHCenter);
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(<span class="keyword">new</span> <span class="type"><a href="./qlabel.htm" translate="no">QLabel</a></span>(text)<span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>AlignCenter);

    <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>widget <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span>;
    widget<span class="operator">-</span><span class="operator">&gt;</span>setLayout(layout);

    <span class="keyword">return</span> widget;
}</pre></div>
<p>This function creates <a href="./qwidget.htm" translate="no">QWidget</a>s containing a tool button and a label. The widgets created with this function are used for the background tabbed widget item in the tool box.</p>
<p>Here is the <code translate="no">createCellWidget()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>MainWindow<span class="operator">::</span>createCellWidget(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>text<span class="operator">,</span> DiagramItem<span class="operator">::</span>DiagramType type)
{

    DiagramItem item(type<span class="operator">,</span> itemMenu);
    <span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span> icon(item<span class="operator">.</span>image());

    <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span> <span class="operator">*</span>button <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qtoolbutton.htm" translate="no">QToolButton</a></span>;
    button<span class="operator">-</span><span class="operator">&gt;</span>setIcon(icon);
    button<span class="operator">-</span><span class="operator">&gt;</span>setIconSize(<span class="type"><a href="./qsize.htm" translate="no">QSize</a></span>(<span class="number">50</span><span class="operator">,</span> <span class="number">50</span>));
    button<span class="operator">-</span><span class="operator">&gt;</span>setCheckable(<span class="keyword">true</span>);
    buttonGroup<span class="operator">-</span><span class="operator">&gt;</span>addButton(button<span class="operator">,</span> <span class="type">int</span>(type));

    <span class="type"><a href="./qgridlayout.htm" translate="no">QGridLayout</a></span> <span class="operator">*</span>layout <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qgridlayout.htm" translate="no">QGridLayout</a></span>;
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(button<span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>AlignHCenter);
    layout<span class="operator">-</span><span class="operator">&gt;</span>addWidget(<span class="keyword">new</span> <span class="type"><a href="./qlabel.htm" translate="no">QLabel</a></span>(text)<span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>AlignCenter);

    <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>widget <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span>;
    widget<span class="operator">-</span><span class="operator">&gt;</span>setLayout(layout);

    <span class="keyword">return</span> widget;
}</pre></div>
<p>This function returns a <a href="./qwidget.htm" translate="no">QWidget</a> containing a <a href="./qtoolbutton.htm" translate="no">QToolButton</a> with an image of one of the <code translate="no">DiagramItems</code>, i.e., flowchart shapes. The image is created by the <code translate="no">DiagramItem</code> through the <code translate="no">image()</code> function. The <a href="./qbuttongroup.htm" translate="no">QButtonGroup</a> class lets us attach an id (int) with each button; we store the diagram's type, i.e., the DiagramItem::DiagramType enum. We use the stored diagram type when we create new diagram items for the scene. The widgets created with this function is used in the tool box.</p>
<p>Here is the <code translate="no">createColorMenu()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>MainWindow<span class="operator">::</span>createColorMenu(<span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>slot<span class="operator">,</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> defaultColor)
{
    <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span><span class="operator">&gt;</span> colors;
    colors <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>black <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>white <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>red <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>blue <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>yellow;
    <span class="type"><a href="./qstringlist.htm" translate="no">QStringList</a></span> names;
    names <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"black"</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"white"</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"red"</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"blue"</span>)
          <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"yellow"</span>);

    <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>colorMenu <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span>(<span class="keyword">this</span>);
    <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> colors<span class="operator">.</span>count(); <span class="operator">+</span><span class="operator">+</span>i) {
        <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span>action <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qaction.htm" translate="no">QAction</a></span>(names<span class="operator">.</span>at(i)<span class="operator">,</span> <span class="keyword">this</span>);
        action<span class="operator">-</span><span class="operator">&gt;</span>setData(colors<span class="operator">.</span>at(i));
        action<span class="operator">-</span><span class="operator">&gt;</span>setIcon(createColorIcon(colors<span class="operator">.</span>at(i)));
        connect(action<span class="operator">,</span> SIGNAL(triggered())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> slot);
        colorMenu<span class="operator">-</span><span class="operator">&gt;</span>addAction(action);
        <span class="keyword">if</span> (colors<span class="operator">.</span>at(i) <span class="operator">=</span><span class="operator">=</span> defaultColor)
            colorMenu<span class="operator">-</span><span class="operator">&gt;</span>setDefaultAction(action);
    }
    <span class="keyword">return</span> colorMenu;
}</pre></div>
<p>This function creates a color menu that is used as the drop-down menu for the tool buttons in the <code translate="no">colorToolBar</code>. We create an action for each color that we add to the menu. We fetch the actions data when we set the color of items, lines, and text.</p>
<p>Here is the <code translate="no">createColorToolButtonIcon()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span> MainWindow<span class="operator">::</span>createColorToolButtonIcon(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>imageFile<span class="operator">,</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> color)
{
    <span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span> pixmap(<span class="number">50</span><span class="operator">,</span> <span class="number">80</span>);
    pixmap<span class="operator">.</span>fill(<span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>transparent);
    <span class="type"><a href="./qpainter.htm" translate="no">QPainter</a></span> painter(<span class="operator">&amp;</span>pixmap);
    <span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span> image(imageFile);
    <span class="comment">// Draw icon centred horizontally on button.</span>
    <span class="type"><a href="./qrect.htm" translate="no">QRect</a></span> target(<span class="number">4</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">42</span><span class="operator">,</span> <span class="number">43</span>);
    <span class="type"><a href="./qrect.htm" translate="no">QRect</a></span> source(<span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">42</span><span class="operator">,</span> <span class="number">43</span>);
    painter<span class="operator">.</span>fillRect(<span class="type"><a href="./qrect.htm" translate="no">QRect</a></span>(<span class="number">0</span><span class="operator">,</span> <span class="number">60</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">80</span>)<span class="operator">,</span> color);
    painter<span class="operator">.</span>drawPixmap(target<span class="operator">,</span> image<span class="operator">,</span> source);

    <span class="keyword">return</span> <span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span>(pixmap);
}</pre></div>
<p>This function is used to create the <a href="./qicon.htm" translate="no">QIcon</a> of the <code translate="no">fillColorToolButton</code>, <code translate="no">fontColorToolButton</code>, and <code translate="no">lineColorToolButton</code>. The <i translate="no">imageFile</i> string is either the text, flood-fill, or line symbol that is used for the buttons. Beneath the image we draw a filled rectangle using <i translate="no">color</i>.</p>
<p>Here is the <code translate="no">createColorIcon()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span> MainWindow<span class="operator">::</span>createColorIcon(<span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> color)
{
    <span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span> pixmap(<span class="number">20</span><span class="operator">,</span> <span class="number">20</span>);
    <span class="type"><a href="./qpainter.htm" translate="no">QPainter</a></span> painter(<span class="operator">&amp;</span>pixmap);
    painter<span class="operator">.</span>setPen(<span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>NoPen);
    painter<span class="operator">.</span>fillRect(<span class="type"><a href="./qrect.htm" translate="no">QRect</a></span>(<span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">20</span><span class="operator">,</span> <span class="number">20</span>)<span class="operator">,</span> color);

    <span class="keyword">return</span> <span class="type"><a href="./qicon.htm" translate="no">QIcon</a></span>(pixmap);
}</pre></div>
<p>This function creates an icon with a filled rectangle in the color of <i translate="no">color</i>. It is used for creating icons for the color menus in the <code translate="no">fillColorToolButton</code>, <code translate="no">fontColorToolButton</code>, and <code translate="no">lineColorToolButton</code>.</p>
<p>Here is the <code translate="no">backgroundButtonGroupClicked()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>backgroundButtonGroupClicked(<span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span>button)
{
    <span class="keyword">const</span> <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span><span class="operator">&gt;</span> buttons <span class="operator">=</span> backgroundButtonGroup<span class="operator">-</span><span class="operator">&gt;</span>buttons();
    <span class="keyword">for</span> (<span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span>myButton : buttons) {
        <span class="keyword">if</span> (myButton <span class="operator">!</span><span class="operator">=</span> button)
            button<span class="operator">-</span><span class="operator">&gt;</span>setChecked(<span class="keyword">false</span>);
    }
    <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> text <span class="operator">=</span> button<span class="operator">-</span><span class="operator">&gt;</span>text();
    <span class="keyword">if</span> (text <span class="operator">=</span><span class="operator">=</span> tr(<span class="string">"Blue Grid"</span>))
        scene<span class="operator">-</span><span class="operator">&gt;</span>setBackgroundBrush(<span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span>(<span class="string">":/images/background1.png"</span>));
    <span class="keyword">else</span> <span class="keyword">if</span> (text <span class="operator">=</span><span class="operator">=</span> tr(<span class="string">"White Grid"</span>))
        scene<span class="operator">-</span><span class="operator">&gt;</span>setBackgroundBrush(<span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span>(<span class="string">":/images/background2.png"</span>));
    <span class="keyword">else</span> <span class="keyword">if</span> (text <span class="operator">=</span><span class="operator">=</span> tr(<span class="string">"Gray Grid"</span>))
        scene<span class="operator">-</span><span class="operator">&gt;</span>setBackgroundBrush(<span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span>(<span class="string">":/images/background3.png"</span>));
    <span class="keyword">else</span>
        scene<span class="operator">-</span><span class="operator">&gt;</span>setBackgroundBrush(<span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span>(<span class="string">":/images/background4.png"</span>));

    scene<span class="operator">-</span><span class="operator">&gt;</span>update();
    view<span class="operator">-</span><span class="operator">&gt;</span>update();
}</pre></div>
<p>In this function we set the <a href="./qbrush.htm" translate="no">QBrush</a> that is used to draw the background of the diagramscene. The background can be a grid of squares of blue, gray, or white tiles, or no grid at all. We have <a href="./qpixmap.htm" translate="no">QPixmap</a>s of the tiles from png files that we create the brush with.</p>
<p>When one of the buttons in the background tabbed widget item is clicked we change the brush; we find out which button it is by checking its text.</p>
<p>Here is the implementation of <code translate="no">buttonGroupClicked()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>buttonGroupClicked(<span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span>button)
{
    <span class="keyword">const</span> <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span><span class="operator">&gt;</span> buttons <span class="operator">=</span> buttonGroup<span class="operator">-</span><span class="operator">&gt;</span>buttons();
    <span class="keyword">for</span> (<span class="type"><a href="./qabstractbutton.htm" translate="no">QAbstractButton</a></span> <span class="operator">*</span>myButton : buttons) {
        <span class="keyword">if</span> (myButton <span class="operator">!</span><span class="operator">=</span> button)
            button<span class="operator">-</span><span class="operator">&gt;</span>setChecked(<span class="keyword">false</span>);
    }
    <span class="keyword">const</span> <span class="type">int</span> id <span class="operator">=</span> buttonGroup<span class="operator">-</span><span class="operator">&gt;</span>id(button);
    <span class="keyword">if</span> (id <span class="operator">=</span><span class="operator">=</span> InsertTextButton) {
        scene<span class="operator">-</span><span class="operator">&gt;</span>setMode(DiagramScene<span class="operator">::</span>InsertText);
    } <span class="keyword">else</span> {
        scene<span class="operator">-</span><span class="operator">&gt;</span>setItemType(DiagramItem<span class="operator">::</span>DiagramType(id));
        scene<span class="operator">-</span><span class="operator">&gt;</span>setMode(DiagramScene<span class="operator">::</span>InsertItem);
    }
}</pre></div>
<p>This slot is called when a button in <code translate="no">buttonGroup</code> is checked. When a button is checked the user can click on the graphics view and a <code translate="no">DiagramItem</code> of the selected type will be inserted into the <code translate="no">DiagramScene</code>. We must loop through the buttons in the group to uncheck other buttons as only one button is allowed to be checked at a time.</p>
<p><code translate="no">QButtonGroup</code> assigns an id to each button. We have set the id of each button to the diagram type, as given by DiagramItem::DiagramType that will be inserted into the scene when it is clicked. We can then use the button id when we set the diagram type with <code translate="no">setItemType()</code>. In the case of text we assigned an id that has a value that is not in the DiagramType enum.</p>
<p>Here is the implementation of <code translate="no">deleteItem()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>deleteItem()
{
    <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span><span class="operator">&gt;</span> selectedItems <span class="operator">=</span> scene<span class="operator">-</span><span class="operator">&gt;</span>selectedItems();
    <span class="keyword">for</span> (<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item : qAsConst(selectedItems)) {
        <span class="keyword">if</span> (item<span class="operator">-</span><span class="operator">&gt;</span>type() <span class="operator">=</span><span class="operator">=</span> Arrow<span class="operator">::</span>Type) {
            scene<span class="operator">-</span><span class="operator">&gt;</span>removeItem(item);
            Arrow <span class="operator">*</span>arrow <span class="operator">=</span> qgraphicsitem_cast<span class="operator">&lt;</span>Arrow <span class="operator">*</span><span class="operator">&gt;</span>(item);
            arrow<span class="operator">-</span><span class="operator">&gt;</span>startItem()<span class="operator">-</span><span class="operator">&gt;</span>removeArrow(arrow);
            arrow<span class="operator">-</span><span class="operator">&gt;</span>endItem()<span class="operator">-</span><span class="operator">&gt;</span>removeArrow(arrow);
            <span class="keyword">delete</span> item;
        }
    }

    selectedItems <span class="operator">=</span> scene<span class="operator">-</span><span class="operator">&gt;</span>selectedItems();
    <span class="keyword">for</span> (<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item : qAsConst(selectedItems)) {
         <span class="keyword">if</span> (item<span class="operator">-</span><span class="operator">&gt;</span>type() <span class="operator">=</span><span class="operator">=</span> DiagramItem<span class="operator">::</span>Type)
             qgraphicsitem_cast<span class="operator">&lt;</span>DiagramItem <span class="operator">*</span><span class="operator">&gt;</span>(item)<span class="operator">-</span><span class="operator">&gt;</span>removeArrows();
         scene<span class="operator">-</span><span class="operator">&gt;</span>removeItem(item);
         <span class="keyword">delete</span> item;
     }
}</pre></div>
<p>This slot deletes the selected item, if any, from the scene. It deletes the arrows first in order to avoid to delete them twice. If the item to be deleted is a <code translate="no">DiagramItem</code>, we also need to delete arrows connected to it; we don't want arrows in the scene that aren't connected to items in both ends.</p>
<p>This is the implementation of pointerGroupClicked():</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>pointerGroupClicked()
{
    scene<span class="operator">-</span><span class="operator">&gt;</span>setMode(DiagramScene<span class="operator">::</span>Mode(pointerTypeGroup<span class="operator">-</span><span class="operator">&gt;</span>checkedId()));
}</pre></div>
<p>The <code translate="no">pointerTypeGroup</code> decides whether the scene is in ItemMove or InsertLine mode. This button group is exclusive, i.e., only one button is checked at any time. As with the <code translate="no">buttonGroup</code> above we have assigned an id to the buttons that matches values of the DiagramScene::Mode enum, so that we can use the id to set the correct mode.</p>
<p>Here is the <code translate="no">bringToFront()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>bringToFront()
{
    <span class="keyword">if</span> (scene<span class="operator">-</span><span class="operator">&gt;</span>selectedItems()<span class="operator">.</span>isEmpty())
        <span class="keyword">return</span>;

    <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>selectedItem <span class="operator">=</span> scene<span class="operator">-</span><span class="operator">&gt;</span>selectedItems()<span class="operator">.</span>first();
    <span class="keyword">const</span> <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span><span class="operator">&gt;</span> overlapItems <span class="operator">=</span> selectedItem<span class="operator">-</span><span class="operator">&gt;</span>collidingItems();

    <span class="type"><a href="./qtglobal.htm#qreal-typedef" translate="no">qreal</a></span> zValue <span class="operator">=</span> <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item : overlapItems) {
        <span class="keyword">if</span> (item<span class="operator">-</span><span class="operator">&gt;</span>zValue() <span class="operator">&gt;</span><span class="operator">=</span> zValue <span class="operator">&amp;</span><span class="operator">&amp;</span> item<span class="operator">-</span><span class="operator">&gt;</span>type() <span class="operator">=</span><span class="operator">=</span> DiagramItem<span class="operator">::</span>Type)
            zValue <span class="operator">=</span> item<span class="operator">-</span><span class="operator">&gt;</span>zValue() <span class="operator">+</span> <span class="number">0.1</span>;
    }
    selectedItem<span class="operator">-</span><span class="operator">&gt;</span>setZValue(zValue);
}</pre></div>
<p>Several items may collide, i.e., overlap, with each other in the scene. This slot is called when the user requests that an item should be placed on top of the items it collides with. <a href="./qgraphicsitem.htm" translate="no">QGrapicsItems</a> have a z-value that decides the order in which items are stacked in the scene; you can think of it as the z-axis in a 3D coordinate system. When items collide the items with higher z-values will be drawn on top of items with lower values. When we bring an item to the front we can loop through the items it collides with and set a z-value that is higher than all of them.</p>
<p>Here is the <code translate="no">sendToBack()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>sendToBack()
{
    <span class="keyword">if</span> (scene<span class="operator">-</span><span class="operator">&gt;</span>selectedItems()<span class="operator">.</span>isEmpty())
        <span class="keyword">return</span>;

    <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>selectedItem <span class="operator">=</span> scene<span class="operator">-</span><span class="operator">&gt;</span>selectedItems()<span class="operator">.</span>first();
    <span class="keyword">const</span> <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span><span class="operator">&gt;</span> overlapItems <span class="operator">=</span> selectedItem<span class="operator">-</span><span class="operator">&gt;</span>collidingItems();

    <span class="type"><a href="./qtglobal.htm#qreal-typedef" translate="no">qreal</a></span> zValue <span class="operator">=</span> <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item : overlapItems) {
        <span class="keyword">if</span> (item<span class="operator">-</span><span class="operator">&gt;</span>zValue() <span class="operator">&lt;</span><span class="operator">=</span> zValue <span class="operator">&amp;</span><span class="operator">&amp;</span> item<span class="operator">-</span><span class="operator">&gt;</span>type() <span class="operator">=</span><span class="operator">=</span> DiagramItem<span class="operator">::</span>Type)
            zValue <span class="operator">=</span> item<span class="operator">-</span><span class="operator">&gt;</span>zValue() <span class="operator">-</span> <span class="number">0.1</span>;
    }
    selectedItem<span class="operator">-</span><span class="operator">&gt;</span>setZValue(zValue);
}</pre></div>
<p>This slot works in the same way as <code translate="no">bringToFront()</code> described above, but sets a z-value that is lower than items the item that should be send to the back collides with.</p>
<p>This is the implementation of <code translate="no">itemInserted()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>itemInserted(DiagramItem <span class="operator">*</span>item)
{
    pointerTypeGroup<span class="operator">-</span><span class="operator">&gt;</span>button(<span class="type">int</span>(DiagramScene<span class="operator">::</span>MoveItem))<span class="operator">-</span><span class="operator">&gt;</span>setChecked(<span class="keyword">true</span>);
    scene<span class="operator">-</span><span class="operator">&gt;</span>setMode(DiagramScene<span class="operator">::</span>Mode(pointerTypeGroup<span class="operator">-</span><span class="operator">&gt;</span>checkedId()));
    buttonGroup<span class="operator">-</span><span class="operator">&gt;</span>button(<span class="type">int</span>(item<span class="operator">-</span><span class="operator">&gt;</span>diagramType()))<span class="operator">-</span><span class="operator">&gt;</span>setChecked(<span class="keyword">false</span>);
}</pre></div>
<p>This slot is called from the <code translate="no">DiagramScene</code> when an item has been added to the scene. We set the mode of the scene back to the mode before the item was inserted, which is ItemMove or InsertText depending on which button is checked in the <code translate="no">pointerTypeGroup</code>. We must also uncheck the button in the in the <code translate="no">buttonGroup</code>.</p>
<p>Here is the implementation of <code translate="no">textInserted()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>textInserted(<span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span> <span class="operator">*</span>)
{
    buttonGroup<span class="operator">-</span><span class="operator">&gt;</span>button(InsertTextButton)<span class="operator">-</span><span class="operator">&gt;</span>setChecked(<span class="keyword">false</span>);
    scene<span class="operator">-</span><span class="operator">&gt;</span>setMode(DiagramScene<span class="operator">::</span>Mode(pointerTypeGroup<span class="operator">-</span><span class="operator">&gt;</span>checkedId()));
}</pre></div>
<p>We simply set the mode of the scene back to the mode it had before the text was inserted.</p>
<p>Here is the <code translate="no">currentFontChanged()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>currentFontChanged(<span class="keyword">const</span> <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> <span class="operator">&amp;</span>)
{
    handleFontChange();
}</pre></div>
<p>When the user requests a font change, by using one of the widgets in the <code translate="no">fontToolBar</code>, we create a new <a href="./qfont.htm" translate="no">QFont</a> object and set its properties to match the state of the widgets. This is done in <code translate="no">handleFontChange()</code>, so we simply call that slot.</p>
<p>Here is the <code translate="no">fontSizeChanged()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>fontSizeChanged(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>)
{
    handleFontChange();
}</pre></div>
<p>When the user requests a font change, by using one of the widgets in the <code translate="no">fontToolBar</code>, we create a new <a href="./qfont.htm" translate="no">QFont</a> object and set its properties to match the state of the widgets. This is done in <code translate="no">handleFontChange()</code>, so we simply call that slot.</p>
<p>Here is the implementation of <code translate="no">sceneScaleChanged()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>sceneScaleChanged(<span class="keyword">const</span> <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> <span class="operator">&amp;</span>scale)
{
    <span class="type">double</span> newScale <span class="operator">=</span> scale<span class="operator">.</span>left(scale<span class="operator">.</span>indexOf(tr(<span class="string">"%"</span>)))<span class="operator">.</span>toDouble() <span class="operator">/</span> <span class="number">100.0</span>;
    <span class="type"><a href="./qtransform.htm" translate="no">QTransform</a></span> oldMatrix <span class="operator">=</span> view<span class="operator">-</span><span class="operator">&gt;</span>transform();
    view<span class="operator">-</span><span class="operator">&gt;</span>resetTransform();
    view<span class="operator">-</span><span class="operator">&gt;</span>translate(oldMatrix<span class="operator">.</span>dx()<span class="operator">,</span> oldMatrix<span class="operator">.</span>dy());
    view<span class="operator">-</span><span class="operator">&gt;</span>scale(newScale<span class="operator">,</span> newScale);
}</pre></div>
<p>The user can increase or decrease the scale, with the <code translate="no">sceneScaleCombo</code>, the scene is drawn in. It is not the scene itself that changes its scale, but only the view.</p>
<p>Here is the <code translate="no">textColorChanged()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>textColorChanged()
{
    textAction <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span><span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span><span class="operator">&gt;</span>(sender());
    fontColorToolButton<span class="operator">-</span><span class="operator">&gt;</span>setIcon(createColorToolButtonIcon(
                                     <span class="string">":/images/textpointer.png"</span><span class="operator">,</span>
                                     qvariant_cast<span class="operator">&lt;</span><span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span><span class="operator">&gt;</span>(textAction<span class="operator">-</span><span class="operator">&gt;</span>data())));
    textButtonTriggered();
}</pre></div>
<p>This slot is called when an item in the drop-down menu of the <code translate="no">fontColorToolButton</code> is pressed. We need to change the icon on the button to the color of the selected <a href="./qaction.htm" translate="no">QAction</a>. We keep a pointer to the selected action in <code translate="no">textAction</code>. It is in <code translate="no">textButtonTriggered()</code> we change the text color to the color of <code translate="no">textAction</code>, so we call that slot.</p>
<p>Here is the <code translate="no">itemColorChanged()</code> implementation:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>itemColorChanged()
{
    fillAction <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span><span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span><span class="operator">&gt;</span>(sender());
    fillColorToolButton<span class="operator">-</span><span class="operator">&gt;</span>setIcon(createColorToolButtonIcon(
                                     <span class="string">":/images/floodfill.png"</span><span class="operator">,</span>
                                     qvariant_cast<span class="operator">&lt;</span><span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span><span class="operator">&gt;</span>(fillAction<span class="operator">-</span><span class="operator">&gt;</span>data())));
    fillButtonTriggered();
}</pre></div>
<p>This slot handles requests for changing the color of <code translate="no">DiagramItems</code> in the same manner as <code translate="no">textColorChanged()</code> does for <code translate="no">DiagramTextItems</code>.</p>
<p>Here is the implementation of <code translate="no">lineColorChanged()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>lineColorChanged()
{
    lineAction <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span><span class="type"><a href="./qaction.htm" translate="no">QAction</a></span> <span class="operator">*</span><span class="operator">&gt;</span>(sender());
    lineColorToolButton<span class="operator">-</span><span class="operator">&gt;</span>setIcon(createColorToolButtonIcon(
                                     <span class="string">":/images/linecolor.png"</span><span class="operator">,</span>
                                     qvariant_cast<span class="operator">&lt;</span><span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span><span class="operator">&gt;</span>(lineAction<span class="operator">-</span><span class="operator">&gt;</span>data())));
    lineButtonTriggered();
}</pre></div>
<p>This slot handles requests for changing the color of <code translate="no">Arrows</code> in the same manner that <code translate="no">textColorChanged()</code> does it for <code translate="no">DiagramTextItems</code>.</p>
<p>Here is the <code translate="no">textButtonTriggered()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>textButtonTriggered()
{
    scene<span class="operator">-</span><span class="operator">&gt;</span>setTextColor(qvariant_cast<span class="operator">&lt;</span><span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span><span class="operator">&gt;</span>(textAction<span class="operator">-</span><span class="operator">&gt;</span>data()));
}</pre></div>
<p><code translate="no">textAction</code> points to the <a href="./qaction.htm" translate="no">QAction</a> of the currently selected menu item in the <code translate="no">fontColorToolButton</code>'s color drop-down menu. We have set the data of the action to the <a href="./qcolor.htm" translate="no">QColor</a> the action represents, so we can simply fetch this when we set the color of text with <code translate="no">setTextColor()</code>.</p>
<p>Here is the <code translate="no">fillButtonTriggered()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>fillButtonTriggered()
{
    scene<span class="operator">-</span><span class="operator">&gt;</span>setItemColor(qvariant_cast<span class="operator">&lt;</span><span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span><span class="operator">&gt;</span>(fillAction<span class="operator">-</span><span class="operator">&gt;</span>data()));
}</pre></div>
<p><code translate="no">fillAction</code> points to the selected menu item in the drop-down menu of <code translate="no">fillColorToolButton()</code>. We can therefore use the data of this action when we set the item color with <code translate="no">setItemColor()</code>.</p>
<p>Here is the <code translate="no">lineButtonTriggered()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>lineButtonTriggered()
{
    scene<span class="operator">-</span><span class="operator">&gt;</span>setLineColor(qvariant_cast<span class="operator">&lt;</span><span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span><span class="operator">&gt;</span>(lineAction<span class="operator">-</span><span class="operator">&gt;</span>data()));
}</pre></div>
<p><code translate="no">lineAction</code> point to the selected item in the drop-down menu of <code translate="no">lineColorToolButton</code>. We use its data when we set the arrow color with <code translate="no">setLineColor()</code>.</p>
<p>Here is the <code translate="no">handleFontChange()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>handleFontChange()
{
    <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> font <span class="operator">=</span> fontCombo<span class="operator">-</span><span class="operator">&gt;</span>currentFont();
    font<span class="operator">.</span>setPointSize(fontSizeCombo<span class="operator">-</span><span class="operator">&gt;</span>currentText()<span class="operator">.</span>toInt());
    font<span class="operator">.</span>setWeight(boldAction<span class="operator">-</span><span class="operator">&gt;</span>isChecked() <span class="operator">?</span> <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span><span class="operator">::</span>Bold : <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span><span class="operator">::</span>Normal);
    font<span class="operator">.</span>setItalic(italicAction<span class="operator">-</span><span class="operator">&gt;</span>isChecked());
    font<span class="operator">.</span>setUnderline(underlineAction<span class="operator">-</span><span class="operator">&gt;</span>isChecked());

    scene<span class="operator">-</span><span class="operator">&gt;</span>setFont(font);
}</pre></div>
<p><code translate="no">handleFontChange()</code> is called when any of the widgets that show font properties changes. We create a new <a href="./qfont.htm" translate="no">QFont</a> object and set its properties based on the widgets. We then call the <code translate="no">setFont()</code> function of <code translate="no">DiagramScene</code>; it is the scene that set the font of the <code translate="no">DiagramTextItems</code> it manages.</p>
<p>Here is the <code translate="no">itemSelected()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>itemSelected(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item)
{
    DiagramTextItem <span class="operator">*</span>textItem <span class="operator">=</span>
    qgraphicsitem_cast<span class="operator">&lt;</span>DiagramTextItem <span class="operator">*</span><span class="operator">&gt;</span>(item);

    <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> font <span class="operator">=</span> textItem<span class="operator">-</span><span class="operator">&gt;</span>font();
    fontCombo<span class="operator">-</span><span class="operator">&gt;</span>setCurrentFont(font);
    fontSizeCombo<span class="operator">-</span><span class="operator">&gt;</span>setEditText(<span class="type"><a href="./qstring.htm" translate="no">QString</a></span>()<span class="operator">.</span>setNum(font<span class="operator">.</span>pointSize()));
    boldAction<span class="operator">-</span><span class="operator">&gt;</span>setChecked(font<span class="operator">.</span>weight() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span><span class="operator">::</span>Bold);
    italicAction<span class="operator">-</span><span class="operator">&gt;</span>setChecked(font<span class="operator">.</span>italic());
    underlineAction<span class="operator">-</span><span class="operator">&gt;</span>setChecked(font<span class="operator">.</span>underline());
}</pre></div>
<p>This slot is called when an item in the <code translate="no">DiagramScene</code> is selected. In the case of this example it is only text items that emit signals when they are selected, so we do not need to check what kind of graphics <i translate="no">item</i> is.</p>
<p>We set the state of the widgets to match the properties of the font of the selected text item.</p>
<p>This is the <code translate="no">about()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> MainWindow<span class="operator">::</span>about()
{
    <span class="type"><a href="./qmessagebox.htm" translate="no">QMessageBox</a></span><span class="operator">::</span>about(<span class="keyword">this</span><span class="operator">,</span> tr(<span class="string">"About Diagram Scene"</span>)<span class="operator">,</span>
                       tr(<span class="string">"The &lt;b&gt;Diagram Scene&lt;/b&gt; example shows "</span>
                          <span class="string">"use of the graphics framework."</span>));
}</pre></div>
<p>This slot displays an about box for the example when the user selects the about menu item from the help menu.</p>
<a name="diagramscene-class-definition"></a>
<h4 id="diagramscene-class-definition">DiagramScene Class Definition<a class="plink" href="#diagramscene-class-definition" title="Direct link to this headline"></a></h4>
<p>The <code translate="no">DiagramScene</code> class inherits <a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a> and adds functionality to handle <code translate="no">DiagramItems</code>, <code translate="no">Arrows</code>, and <code translate="no">DiagramTextItems</code> in addition to the items handled by its super class.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="keyword">class</span> DiagramScene : <span class="keyword">public</span> <span class="type"><a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a></span>
{
    Q_OBJECT

<span class="keyword">public</span>:
    <span class="keyword">enum</span> Mode { InsertItem<span class="operator">,</span> InsertLine<span class="operator">,</span> InsertText<span class="operator">,</span> MoveItem };

    <span class="keyword">explicit</span> DiagramScene(<span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>itemMenu<span class="operator">,</span> <span class="type"><a href="./qobject.htm" translate="no">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);
    <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> font() <span class="keyword">const</span> { <span class="keyword">return</span> myFont; }
    <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> textColor() <span class="keyword">const</span> { <span class="keyword">return</span> myTextColor; }
    <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> itemColor() <span class="keyword">const</span> { <span class="keyword">return</span> myItemColor; }
    <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> lineColor() <span class="keyword">const</span> { <span class="keyword">return</span> myLineColor; }
    <span class="type">void</span> setLineColor(<span class="keyword">const</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> <span class="operator">&amp;</span>color);
    <span class="type">void</span> setTextColor(<span class="keyword">const</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> <span class="operator">&amp;</span>color);
    <span class="type">void</span> setItemColor(<span class="keyword">const</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> <span class="operator">&amp;</span>color);
    <span class="type">void</span> setFont(<span class="keyword">const</span> <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> <span class="operator">&amp;</span>font);

<span class="keyword">public</span> <span class="keyword">slots</span>:
    <span class="type">void</span> setMode(Mode mode);
    <span class="type">void</span> setItemType(DiagramItem<span class="operator">::</span>DiagramType type);
    <span class="type">void</span> editorLostFocus(DiagramTextItem <span class="operator">*</span>item);

<span class="keyword">signals</span>:
    <span class="type">void</span> itemInserted(DiagramItem <span class="operator">*</span>item);
    <span class="type">void</span> textInserted(<span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span> <span class="operator">*</span>item);
    <span class="type">void</span> itemSelected(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item);

<span class="keyword">protected</span>:
    <span class="type">void</span> mousePressEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>mouseEvent) override;
    <span class="type">void</span> mouseMoveEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>mouseEvent) override;
    <span class="type">void</span> mouseReleaseEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>mouseEvent) override;

<span class="keyword">private</span>:
    bool isItemChange(<span class="type">int</span> type) <span class="keyword">const</span>;

    DiagramItem<span class="operator">::</span>DiagramType myItemType;
    <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>myItemMenu;
    Mode myMode;
    bool leftButtonDown;
    <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span> startPoint;
    <span class="type"><a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a></span> <span class="operator">*</span>line;
    <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> myFont;
    DiagramTextItem <span class="operator">*</span>textItem;
    <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> myTextColor;
    <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> myItemColor;
    <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> myLineColor;
};</pre></div>
<p>In the <code translate="no">DiagramScene</code> a mouse click can give three different actions: the item under the mouse can be moved, an item may be inserted, or an arrow may be connected between to diagram items. Which action a mouse click has depends on the mode, given by the Mode enum, the scene is in. The mode is set with the <code translate="no">setMode()</code> function.</p>
<p>The scene also sets the color of its items and the font of its text items. The colors and font used by the scene can be set with the <code translate="no">setLineColor()</code>, <code translate="no">setTextColor()</code>, <code translate="no">setItemColor()</code> and <code translate="no">setFont()</code> functions. The type of <code translate="no">DiagramItem</code>, given by the DiagramItem::DiagramType function, to be created when an item is inserted is set with the <code translate="no">setItemType()</code> slot.</p>
<p>The <code translate="no">MainWindow</code> and <code translate="no">DiagramScene</code> share responsibility for the examples functionality. <code translate="no">MainWindow</code> handles the following tasks: the deletion of items, text, and arrows; moving diagram items to the back and front; and setting the scale of the scene.</p>
<a name="diagramscene-class-implementation"></a>
<h4 id="diagramscene-class-implementation">DiagramScene Class Implementation<a class="plink" href="#diagramscene-class-implementation" title="Direct link to this headline"></a></h4>
<p>We start with the constructor:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">DiagramScene<span class="operator">::</span>DiagramScene(<span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>itemMenu<span class="operator">,</span> <span class="type"><a href="./qobject.htm" translate="no">QObject</a></span> <span class="operator">*</span>parent)
    : <span class="type"><a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a></span>(parent)
{
    myItemMenu <span class="operator">=</span> itemMenu;
    myMode <span class="operator">=</span> MoveItem;
    myItemType <span class="operator">=</span> DiagramItem<span class="operator">::</span>Step;
    line <span class="operator">=</span> nullptr;
    textItem <span class="operator">=</span> nullptr;
    myItemColor <span class="operator">=</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>white;
    myTextColor <span class="operator">=</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>black;
    myLineColor <span class="operator">=</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>black;
}</pre></div>
<p>The scene uses <code translate="no">myItemMenu</code> to set the context menu when it creates <code translate="no">DiagramItems</code>. We set the default mode to <code translate="no">DiagramScene::MoveItem</code> as this gives the default behavior of <a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a>.</p>
<p>Here is the <code translate="no">setLineColor()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>setLineColor(<span class="keyword">const</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> <span class="operator">&amp;</span>color)
{
    myLineColor <span class="operator">=</span> color;
    <span class="keyword">if</span> (isItemChange(Arrow<span class="operator">::</span>Type)) {
        Arrow <span class="operator">*</span>item <span class="operator">=</span> qgraphicsitem_cast<span class="operator">&lt;</span>Arrow <span class="operator">*</span><span class="operator">&gt;</span>(selectedItems()<span class="operator">.</span>first());
        item<span class="operator">-</span><span class="operator">&gt;</span>setColor(myLineColor);
        update();
    }
}</pre></div>
<p>The <code translate="no">isItemChange</code> function returns true if an <code translate="no">Arrow</code> item is selected in the scene in which case we want to change its color. When the <code translate="no">DiagramScene</code> creates and adds new arrows to the scene it will also use the new <i translate="no">color</i>.</p>
<p>Here is the <code translate="no">setTextColor()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>setTextColor(<span class="keyword">const</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> <span class="operator">&amp;</span>color)
{
    myTextColor <span class="operator">=</span> color;
    <span class="keyword">if</span> (isItemChange(DiagramTextItem<span class="operator">::</span>Type)) {
        DiagramTextItem <span class="operator">*</span>item <span class="operator">=</span> qgraphicsitem_cast<span class="operator">&lt;</span>DiagramTextItem <span class="operator">*</span><span class="operator">&gt;</span>(selectedItems()<span class="operator">.</span>first());
        item<span class="operator">-</span><span class="operator">&gt;</span>setDefaultTextColor(myTextColor);
    }
}</pre></div>
<p>This function sets the color of <code translate="no">DiagramTextItems</code> equal to the way <code translate="no">setLineColor()</code> sets the color of <code translate="no">Arrows</code>.</p>
<p>Here is the <code translate="no">setItemColor()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>setItemColor(<span class="keyword">const</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> <span class="operator">&amp;</span>color)
{
    myItemColor <span class="operator">=</span> color;
    <span class="keyword">if</span> (isItemChange(DiagramItem<span class="operator">::</span>Type)) {
        DiagramItem <span class="operator">*</span>item <span class="operator">=</span> qgraphicsitem_cast<span class="operator">&lt;</span>DiagramItem <span class="operator">*</span><span class="operator">&gt;</span>(selectedItems()<span class="operator">.</span>first());
        item<span class="operator">-</span><span class="operator">&gt;</span>setBrush(myItemColor);
    }
}</pre></div>
<p>This function sets the color the scene will use when creating <code translate="no">DiagramItems</code>. It also changes the color of a selected <code translate="no">DiagramItem</code>.</p>
<p>This is the implementation of <code translate="no">setFont()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>setFont(<span class="keyword">const</span> <span class="type"><a href="./qfont.htm" translate="no">QFont</a></span> <span class="operator">&amp;</span>font)
{
    myFont <span class="operator">=</span> font;

    <span class="keyword">if</span> (isItemChange(DiagramTextItem<span class="operator">::</span>Type)) {
        <span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span> <span class="operator">*</span>item <span class="operator">=</span> qgraphicsitem_cast<span class="operator">&lt;</span>DiagramTextItem <span class="operator">*</span><span class="operator">&gt;</span>(selectedItems()<span class="operator">.</span>first());
        <span class="comment">//At this point the selection can change so the first selected item might not be a DiagramTextItem</span>
        <span class="keyword">if</span> (item)
            item<span class="operator">-</span><span class="operator">&gt;</span>setFont(myFont);
    }
}</pre></div>
<p>Set the font to use for new and selected, if a text item is selected, <code translate="no">DiagramTextItems</code>.</p>
<p>This is the implementation of <code translate="no">editorLostFocus()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>editorLostFocus(DiagramTextItem <span class="operator">*</span>item)
{
    <span class="type"><a href="./qtextcursor.htm" translate="no">QTextCursor</a></span> cursor <span class="operator">=</span> item<span class="operator">-</span><span class="operator">&gt;</span>textCursor();
    cursor<span class="operator">.</span>clearSelection();
    item<span class="operator">-</span><span class="operator">&gt;</span>setTextCursor(cursor);

    <span class="keyword">if</span> (item<span class="operator">-</span><span class="operator">&gt;</span>toPlainText()<span class="operator">.</span>isEmpty()) {
        removeItem(item);
        item<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
    }
}</pre></div>
<p><code translate="no">DiagramTextItems</code> emit a signal when they lose focus, which is connected to this slot. We remove the item if it has no text. If not, we would leak memory and confuse the user as the items will be edited when pressed on by the mouse.</p>
<p>The <code translate="no">mousePressEvent()</code> function handles mouse press event's different depending on which mode the <code translate="no">DiagramScene</code> is in. We examine its implementation for each mode:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>mousePressEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>mouseEvent)
{
    <span class="keyword">if</span> (mouseEvent<span class="operator">-</span><span class="operator">&gt;</span>button() <span class="operator">!</span><span class="operator">=</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>LeftButton)
        <span class="keyword">return</span>;

    DiagramItem <span class="operator">*</span>item;
    <span class="keyword">switch</span> (myMode) {
        <span class="keyword">case</span> InsertItem:
            item <span class="operator">=</span> <span class="keyword">new</span> DiagramItem(myItemType<span class="operator">,</span> myItemMenu);
            item<span class="operator">-</span><span class="operator">&gt;</span>setBrush(myItemColor);
            addItem(item);
            item<span class="operator">-</span><span class="operator">&gt;</span>setPos(mouseEvent<span class="operator">-</span><span class="operator">&gt;</span>scenePos());
            <span class="keyword">emit</span> itemInserted(item);
            <span class="keyword">break</span>;</pre></div>
<p>We simply create a new <code translate="no">DiagramItem</code> and add it to the scene at the position the mouse was pressed. Note that the origin of its local coordinate system will be under the mouse pointer position.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">        <span class="keyword">case</span> InsertLine:
            line <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a></span>(<span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span>(mouseEvent<span class="operator">-</span><span class="operator">&gt;</span>scenePos()<span class="operator">,</span>
                                        mouseEvent<span class="operator">-</span><span class="operator">&gt;</span>scenePos()));
            line<span class="operator">-</span><span class="operator">&gt;</span>setPen(<span class="type"><a href="./qpen.htm" translate="no">QPen</a></span>(myLineColor<span class="operator">,</span> <span class="number">2</span>));
            addItem(line);
            <span class="keyword">break</span>;</pre></div>
<p>The user adds <code translate="no">Arrows</code> to the scene by stretching a line between the items the arrow should connect. The start of the line is fixed in the place the user clicked the mouse and the end follows the mouse pointer as long as the button is held down. When the user releases the mouse button an <code translate="no">Arrow</code> will be added to the scene if there is a <code translate="no">DiagramItem</code> under the start and end of the line. We will see how this is implemented later; here we simply add the line.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">        <span class="keyword">case</span> InsertText:
            textItem <span class="operator">=</span> <span class="keyword">new</span> DiagramTextItem();
            textItem<span class="operator">-</span><span class="operator">&gt;</span>setFont(myFont);
            textItem<span class="operator">-</span><span class="operator">&gt;</span>setTextInteractionFlags(<span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>TextEditorInteraction);
            textItem<span class="operator">-</span><span class="operator">&gt;</span>setZValue(<span class="number">1000.0</span>);
            connect(textItem<span class="operator">,</span> <span class="operator">&amp;</span>DiagramTextItem<span class="operator">::</span>lostFocus<span class="operator">,</span>
                    <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>DiagramScene<span class="operator">::</span>editorLostFocus);
            connect(textItem<span class="operator">,</span> <span class="operator">&amp;</span>DiagramTextItem<span class="operator">::</span>selectedChange<span class="operator">,</span>
                    <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>DiagramScene<span class="operator">::</span>itemSelected);
            addItem(textItem);
            textItem<span class="operator">-</span><span class="operator">&gt;</span>setDefaultTextColor(myTextColor);
            textItem<span class="operator">-</span><span class="operator">&gt;</span>setPos(mouseEvent<span class="operator">-</span><span class="operator">&gt;</span>scenePos());
            <span class="keyword">emit</span> textInserted(textItem);</pre></div>
<p>The <code translate="no">DiagramTextItem</code> is editable when the <a href="./qt.htm#TextInteractionFlag-enum" translate="no">Qt::TextEditorInteraction</a> flag is set, else it is movable by the mouse. We always want the text to be drawn on top of the other items in the scene, so we set the value to a number higher than other items in the scene.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    <span class="keyword">default</span>:
        ;
    }
    <span class="type"><a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a></span><span class="operator">::</span>mousePressEvent(mouseEvent);
}</pre></div>
<p>We are in MoveItem mode if we get to the default switch; we can then call the <a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a> implementation, which handles movement of items with the mouse. We make this call even if we are in another mode making it possible to add an item and then keep the mouse button pressed down and start moving the item. In the case of text items, this is not possible as they do not propagate mouse events when they are editable.</p>
<p>This is the <code translate="no">mouseMoveEvent()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>mouseMoveEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>mouseEvent)
{
    <span class="keyword">if</span> (myMode <span class="operator">=</span><span class="operator">=</span> InsertLine <span class="operator">&amp;</span><span class="operator">&amp;</span> line <span class="operator">!</span><span class="operator">=</span> nullptr) {
        <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span> newLine(line<span class="operator">-</span><span class="operator">&gt;</span>line()<span class="operator">.</span>p1()<span class="operator">,</span> mouseEvent<span class="operator">-</span><span class="operator">&gt;</span>scenePos());
        line<span class="operator">-</span><span class="operator">&gt;</span>setLine(newLine);
    } <span class="keyword">else</span> <span class="keyword">if</span> (myMode <span class="operator">=</span><span class="operator">=</span> MoveItem) {
        <span class="type"><a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a></span><span class="operator">::</span>mouseMoveEvent(mouseEvent);
    }
}</pre></div>
<p>We must draw the line if we are in InsertMode and the mouse button is pressed down (the line is not 0). As discussed in <code translate="no">mousePressEvent()</code> the line is drawn from the position the mouse was pressed to the current position of the mouse.</p>
<p>If we are in MoveItem mode, we call the <a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a> implementation, which handles movement of items.</p>
<p>In the <code translate="no">mouseReleaseEvent()</code> function we need to check if an arrow should be added to the scene:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramScene<span class="operator">::</span>mouseReleaseEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>mouseEvent)
{
    <span class="keyword">if</span> (line <span class="operator">!</span><span class="operator">=</span> nullptr <span class="operator">&amp;</span><span class="operator">&amp;</span> myMode <span class="operator">=</span><span class="operator">=</span> InsertLine) {
        <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span><span class="operator">&gt;</span> startItems <span class="operator">=</span> items(line<span class="operator">-</span><span class="operator">&gt;</span>line()<span class="operator">.</span>p1());
        <span class="keyword">if</span> (startItems<span class="operator">.</span>count() <span class="operator">&amp;</span><span class="operator">&amp;</span> startItems<span class="operator">.</span>first() <span class="operator">=</span><span class="operator">=</span> line)
            startItems<span class="operator">.</span>removeFirst();
        <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span><span class="operator">&gt;</span> endItems <span class="operator">=</span> items(line<span class="operator">-</span><span class="operator">&gt;</span>line()<span class="operator">.</span>p2());
        <span class="keyword">if</span> (endItems<span class="operator">.</span>count() <span class="operator">&amp;</span><span class="operator">&amp;</span> endItems<span class="operator">.</span>first() <span class="operator">=</span><span class="operator">=</span> line)
            endItems<span class="operator">.</span>removeFirst();

        removeItem(line);
        <span class="keyword">delete</span> line;</pre></div>
<p>First we need to get the items (if any) under the line's start and end points. The line itself is the first item at these points, so we remove it from the lists. As a precaution, we check if the lists are empty, but this should never happen.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">        <span class="keyword">if</span> (startItems<span class="operator">.</span>count() <span class="operator">&gt;</span> <span class="number">0</span> <span class="operator">&amp;</span><span class="operator">&amp;</span> endItems<span class="operator">.</span>count() <span class="operator">&gt;</span> <span class="number">0</span> <span class="operator">&amp;</span><span class="operator">&amp;</span>
            startItems<span class="operator">.</span>first()<span class="operator">-</span><span class="operator">&gt;</span>type() <span class="operator">=</span><span class="operator">=</span> DiagramItem<span class="operator">::</span>Type <span class="operator">&amp;</span><span class="operator">&amp;</span>
            endItems<span class="operator">.</span>first()<span class="operator">-</span><span class="operator">&gt;</span>type() <span class="operator">=</span><span class="operator">=</span> DiagramItem<span class="operator">::</span>Type <span class="operator">&amp;</span><span class="operator">&amp;</span>
            startItems<span class="operator">.</span>first() <span class="operator">!</span><span class="operator">=</span> endItems<span class="operator">.</span>first()) {
            DiagramItem <span class="operator">*</span>startItem <span class="operator">=</span> qgraphicsitem_cast<span class="operator">&lt;</span>DiagramItem <span class="operator">*</span><span class="operator">&gt;</span>(startItems<span class="operator">.</span>first());
            DiagramItem <span class="operator">*</span>endItem <span class="operator">=</span> qgraphicsitem_cast<span class="operator">&lt;</span>DiagramItem <span class="operator">*</span><span class="operator">&gt;</span>(endItems<span class="operator">.</span>first());
            Arrow <span class="operator">*</span>arrow <span class="operator">=</span> <span class="keyword">new</span> Arrow(startItem<span class="operator">,</span> endItem);
            arrow<span class="operator">-</span><span class="operator">&gt;</span>setColor(myLineColor);
            startItem<span class="operator">-</span><span class="operator">&gt;</span>addArrow(arrow);
            endItem<span class="operator">-</span><span class="operator">&gt;</span>addArrow(arrow);
            arrow<span class="operator">-</span><span class="operator">&gt;</span>setZValue(<span class="operator">-</span><span class="number">1000.0</span>);
            addItem(arrow);
            arrow<span class="operator">-</span><span class="operator">&gt;</span>updatePosition();
        }
    }</pre></div>
<p>Now we check if there are two different <code translate="no">DiagramItems</code> under the lines start and end points. If there are we can create an <code translate="no">Arrow</code> with the two items. The arrow is then added to each item and finally the scene. The arrow must be updated to adjust its start and end points to the items. We set the z-value of the arrow to -1000.0 because we always want it to be drawn under the items.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    line <span class="operator">=</span> nullptr;
    <span class="type"><a href="./qgraphicsscene.htm" translate="no">QGraphicsScene</a></span><span class="operator">::</span>mouseReleaseEvent(mouseEvent);
}</pre></div>
<p>Here is the <code translate="no">isItemChange()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">bool DiagramScene<span class="operator">::</span>isItemChange(<span class="type">int</span> type) <span class="keyword">const</span>
{
    <span class="keyword">const</span> <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span><span class="operator">&gt;</span> items <span class="operator">=</span> selectedItems();
    <span class="keyword">const</span> <span class="keyword">auto</span> cb <span class="operator">=</span> <span class="operator">[</span>type<span class="operator">]</span>(<span class="keyword">const</span> <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item) { <span class="keyword">return</span> item<span class="operator">-</span><span class="operator">&gt;</span>type() <span class="operator">=</span><span class="operator">=</span> type; };
    <span class="keyword">return</span> std<span class="operator">::</span>find_if(items<span class="operator">.</span>begin()<span class="operator">,</span> items<span class="operator">.</span>end()<span class="operator">,</span> cb) <span class="operator">!</span><span class="operator">=</span> items<span class="operator">.</span>end();
}</pre></div>
<p>The scene has single selection, i.e., only one item can be selected at any given time. The for loop will then loop one time with the selected item or none if no item is selected. <code translate="no">isItemChange()</code> is used to check whether a selected item exists and also is of the specified diagram <i translate="no">type</i>.</p>
<a name="diagramitem-class-definition"></a>
<h4 id="diagramitem-class-definition">DiagramItem Class Definition<a class="plink" href="#diagramitem-class-definition" title="Direct link to this headline"></a></h4>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="keyword">class</span> DiagramItem : <span class="keyword">public</span> <span class="type"><a href="./qgraphicspolygonitem.htm" translate="no">QGraphicsPolygonItem</a></span>
{
<span class="keyword">public</span>:
    <span class="keyword">enum</span> { Type <span class="operator">=</span> UserType <span class="operator">+</span> <span class="number">15</span> };
    <span class="keyword">enum</span> DiagramType { Step<span class="operator">,</span> Conditional<span class="operator">,</span> StartEnd<span class="operator">,</span> Io };

    DiagramItem(DiagramType diagramType<span class="operator">,</span> <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>contextMenu<span class="operator">,</span> <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);

    <span class="type">void</span> removeArrow(Arrow <span class="operator">*</span>arrow);
    <span class="type">void</span> removeArrows();
    DiagramType diagramType() <span class="keyword">const</span> { <span class="keyword">return</span> myDiagramType; }
    <span class="type"><a href="./qpolygonf.htm" translate="no">QPolygonF</a></span> polygon() <span class="keyword">const</span> { <span class="keyword">return</span> myPolygon; }
    <span class="type">void</span> addArrow(Arrow <span class="operator">*</span>arrow);
    <span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span> image() <span class="keyword">const</span>;
    <span class="type">int</span> type() <span class="keyword">const</span> override { <span class="keyword">return</span> Type; }

<span class="keyword">protected</span>:
    <span class="type">void</span> contextMenuEvent(<span class="type"><a href="./qgraphicsscenecontextmenuevent.htm" translate="no">QGraphicsSceneContextMenuEvent</a></span> <span class="operator">*</span>event) override;
    <span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> itemChange(GraphicsItemChange change<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> <span class="operator">&amp;</span>value) override;

<span class="keyword">private</span>:
    DiagramType myDiagramType;
    <span class="type"><a href="./qpolygonf.htm" translate="no">QPolygonF</a></span> myPolygon;
    <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>myContextMenu;
    <span class="type"><a href="./qvector.htm" translate="no">QVector</a></span><span class="operator">&lt;</span>Arrow <span class="operator">*</span><span class="operator">&gt;</span> arrows;
};</pre></div>
<p>The <code translate="no">DiagramItem</code> represents a flowchart shape in the <code translate="no">DiagramScene</code>. It inherits <a href="./qgraphicspolygonitem.htm" translate="no">QGraphicsPolygonItem</a> and has a polygon for each shape. The enum DiagramType has a value for each of the flowchart shapes.</p>
<p>The class has a list of the arrows that are connected to it. This is necessary because only the item knows when it is being moved (with the <code translate="no">itemChanged()</code> function) at which time the arrows must be updated. The item can also draw itself onto a <a href="./qpixmap.htm" translate="no">QPixmap</a> with the <code translate="no">image()</code> function. This is used for the tool buttons in <code translate="no">MainWindow</code>, see <code translate="no">createColorToolButtonIcon()</code> in <code translate="no">MainWindow</code>.</p>
<p>The Type enum is a unique identifier of the class. It is used by <code translate="no">qgraphicsitem_cast()</code>, which does dynamic casts of graphics items. The UserType constant is the minimum value a custom graphics item type can be.</p>
<a name="diagramitem-class-implementation"></a>
<h4 id="diagramitem-class-implementation">DiagramItem Class Implementation<a class="plink" href="#diagramitem-class-implementation" title="Direct link to this headline"></a></h4>
<p>We start with a look at the constructor:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">DiagramItem<span class="operator">::</span>DiagramItem(DiagramType diagramType<span class="operator">,</span> <span class="type"><a href="./qmenu.htm" translate="no">QMenu</a></span> <span class="operator">*</span>contextMenu<span class="operator">,</span>
                         <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>parent)
    : <span class="type"><a href="./qgraphicspolygonitem.htm" translate="no">QGraphicsPolygonItem</a></span>(parent)<span class="operator">,</span> myDiagramType(diagramType)
    <span class="operator">,</span> myContextMenu(contextMenu)
{
    <span class="type"><a href="./qpainterpath.htm" translate="no">QPainterPath</a></span> path;
    <span class="keyword">switch</span> (myDiagramType) {
        <span class="keyword">case</span> StartEnd:
            path<span class="operator">.</span>moveTo(<span class="number">200</span><span class="operator">,</span> <span class="number">50</span>);
            path<span class="operator">.</span>arcTo(<span class="number">150</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">90</span>);
            path<span class="operator">.</span>arcTo(<span class="number">50</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">90</span><span class="operator">,</span> <span class="number">90</span>);
            path<span class="operator">.</span>arcTo(<span class="number">50</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">180</span><span class="operator">,</span> <span class="number">90</span>);
            path<span class="operator">.</span>arcTo(<span class="number">150</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">50</span><span class="operator">,</span> <span class="number">270</span><span class="operator">,</span> <span class="number">90</span>);
            path<span class="operator">.</span>lineTo(<span class="number">200</span><span class="operator">,</span> <span class="number">25</span>);
            myPolygon <span class="operator">=</span> path<span class="operator">.</span>toFillPolygon();
            <span class="keyword">break</span>;
        <span class="keyword">case</span> Conditional:
            myPolygon <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">100</span><span class="operator">,</span> <span class="number">0</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="number">0</span><span class="operator">,</span> <span class="number">100</span>)
                      <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="number">100</span><span class="operator">,</span> <span class="number">0</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="number">0</span><span class="operator">,</span> <span class="operator">-</span><span class="number">100</span>)
                      <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">100</span><span class="operator">,</span> <span class="number">0</span>);
            <span class="keyword">break</span>;
        <span class="keyword">case</span> Step:
            myPolygon <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">100</span><span class="operator">,</span> <span class="operator">-</span><span class="number">100</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="number">100</span><span class="operator">,</span> <span class="operator">-</span><span class="number">100</span>)
                      <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="number">100</span><span class="operator">,</span> <span class="number">100</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">100</span><span class="operator">,</span> <span class="number">100</span>)
                      <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">100</span><span class="operator">,</span> <span class="operator">-</span><span class="number">100</span>);
            <span class="keyword">break</span>;
        <span class="keyword">default</span>:
            myPolygon <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">120</span><span class="operator">,</span> <span class="operator">-</span><span class="number">80</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">70</span><span class="operator">,</span> <span class="number">80</span>)
                      <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="number">120</span><span class="operator">,</span> <span class="number">80</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="number">70</span><span class="operator">,</span> <span class="operator">-</span><span class="number">80</span>)
                      <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(<span class="operator">-</span><span class="number">120</span><span class="operator">,</span> <span class="operator">-</span><span class="number">80</span>);
            <span class="keyword">break</span>;
    }
    setPolygon(myPolygon);
    setFlag(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemIsMovable<span class="operator">,</span> <span class="keyword">true</span>);
    setFlag(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemIsSelectable<span class="operator">,</span> <span class="keyword">true</span>);
    setFlag(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemSendsGeometryChanges<span class="operator">,</span> <span class="keyword">true</span>);
}</pre></div>
<p>In the constructor we create the items polygon according to <i translate="no">diagramType</i>. <a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a>s are not movable or selectable by default, so we must set these properties.</p>
<p>Here is the <code translate="no">removeArrow()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramItem<span class="operator">::</span>removeArrow(Arrow <span class="operator">*</span>arrow)
{
    arrows<span class="operator">.</span>removeAll(arrow);
}</pre></div>
<p><code translate="no">removeArrow()</code> is used to remove <code translate="no">Arrow</code> items when they or <code translate="no">DiagramItems</code> they are connected to are removed from the scene.</p>
<p>Here is the <code translate="no">removeArrows()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramItem<span class="operator">::</span>removeArrows()
{
    <span class="comment">// need a copy here since removeArrow() will</span>
    <span class="comment">// modify the arrows container</span>
    <span class="keyword">const</span> <span class="keyword">auto</span> arrowsCopy <span class="operator">=</span> arrows;
    <span class="keyword">for</span> (Arrow <span class="operator">*</span>arrow : arrowsCopy) {
        arrow<span class="operator">-</span><span class="operator">&gt;</span>startItem()<span class="operator">-</span><span class="operator">&gt;</span>removeArrow(arrow);
        arrow<span class="operator">-</span><span class="operator">&gt;</span>endItem()<span class="operator">-</span><span class="operator">&gt;</span>removeArrow(arrow);
        scene()<span class="operator">-</span><span class="operator">&gt;</span>removeItem(arrow);
        <span class="keyword">delete</span> arrow;
    }
}</pre></div>
<p>This function is called when the item is removed from the scene and removes all arrows that are connected to this item. The arrow must be removed from the <code translate="no">arrows</code> list of both its start and end item. Since either the start or the end item is the object where this function is currently called, we have to make sure to work on a copy of arrows since removeArrow() is modifying this container.</p>
<p>Here is the <code translate="no">addArrow()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramItem<span class="operator">::</span>addArrow(Arrow <span class="operator">*</span>arrow)
{
    arrows<span class="operator">.</span>append(arrow);
}</pre></div>
<p>This function simply adds the <i translate="no">arrow</i> to the items <code translate="no">arrows</code> list.</p>
<p>Here is the <code translate="no">image()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span> DiagramItem<span class="operator">::</span>image() <span class="keyword">const</span>
{
    <span class="type"><a href="./qpixmap.htm" translate="no">QPixmap</a></span> pixmap(<span class="number">250</span><span class="operator">,</span> <span class="number">250</span>);
    pixmap<span class="operator">.</span>fill(<span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>transparent);
    <span class="type"><a href="./qpainter.htm" translate="no">QPainter</a></span> painter(<span class="operator">&amp;</span>pixmap);
    painter<span class="operator">.</span>setPen(<span class="type"><a href="./qpen.htm" translate="no">QPen</a></span>(<span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>black<span class="operator">,</span> <span class="number">8</span>));
    painter<span class="operator">.</span>translate(<span class="number">125</span><span class="operator">,</span> <span class="number">125</span>);
    painter<span class="operator">.</span>drawPolyline(myPolygon);

    <span class="keyword">return</span> pixmap;
}</pre></div>
<p>This function draws the polygon of the item onto a <a href="./qpixmap.htm" translate="no">QPixmap</a>. In this example we use this to create icons for the tool buttons in the tool box.</p>
<p>Here is the <code translate="no">contextMenuEvent()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramItem<span class="operator">::</span>contextMenuEvent(<span class="type"><a href="./qgraphicsscenecontextmenuevent.htm" translate="no">QGraphicsSceneContextMenuEvent</a></span> <span class="operator">*</span>event)
{
    scene()<span class="operator">-</span><span class="operator">&gt;</span>clearSelection();
    setSelected(<span class="keyword">true</span>);
    myContextMenu<span class="operator">-</span><span class="operator">&gt;</span>exec(event<span class="operator">-</span><span class="operator">&gt;</span>screenPos());
}</pre></div>
<p>We show the context menu. As right mouse clicks, which shows the menu, don't select items by default we set the item selected with <a href="./qgraphicsitem.htm#setSelected" translate="no">setSelected()</a>. This is necessary since an item must be selected to change its elevation with the <code translate="no">bringToFront</code> and <code translate="no">sendToBack</code> actions.</p>
<p>This is the implementation of <code translate="no">itemChange()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> DiagramItem<span class="operator">::</span>itemChange(GraphicsItemChange change<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> <span class="operator">&amp;</span>value)
{
    <span class="keyword">if</span> (change <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemPositionChange) {
        <span class="keyword">for</span> (Arrow <span class="operator">*</span>arrow : qAsConst(arrows))
            arrow<span class="operator">-</span><span class="operator">&gt;</span>updatePosition();
    }

    <span class="keyword">return</span> value;
}</pre></div>
<p>If the item has moved, we need to update the positions of the arrows connected to it. The implementation of <a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a> does nothing, so we just return <i translate="no">value</i>.</p>
<a name="diagramtextitem-class-definition"></a>
<h4 id="diagramtextitem-class-definition">DiagramTextItem Class Definition<a class="plink" href="#diagramtextitem-class-definition" title="Direct link to this headline"></a></h4>
<p>The <code translate="no">TextDiagramItem</code> class inherits <a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a> and adds the possibility to move editable text items. Editable QGraphicsTextItems are designed to be fixed in place and editing starts when the user single clicks on the item. With <code translate="no">DiagramTextItem</code> the editing starts with a double click leaving single click available to interact with and move it.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="keyword">class</span> DiagramTextItem : <span class="keyword">public</span> <span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span>
{
    Q_OBJECT

<span class="keyword">public</span>:
    <span class="keyword">enum</span> { Type <span class="operator">=</span> UserType <span class="operator">+</span> <span class="number">3</span> };

    DiagramTextItem(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);

    <span class="type">int</span> type() <span class="keyword">const</span> override { <span class="keyword">return</span> Type; }

<span class="keyword">signals</span>:
    <span class="type">void</span> lostFocus(DiagramTextItem <span class="operator">*</span>item);
    <span class="type">void</span> selectedChange(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>item);

<span class="keyword">protected</span>:
    <span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> itemChange(GraphicsItemChange change<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> <span class="operator">&amp;</span>value) override;
    <span class="type">void</span> focusOutEvent(<span class="type"><a href="./qfocusevent.htm" translate="no">QFocusEvent</a></span> <span class="operator">*</span>event) override;
    <span class="type">void</span> mouseDoubleClickEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>event) override;
};</pre></div>
<p>We use <code translate="no">itemChange()</code> and <code translate="no">focusOutEvent()</code> to notify the <code translate="no">DiagramScene</code> when the text item loses focus and gets selected.</p>
<p>We reimplement the functions that handle mouse events to make it possible to alter the mouse behavior of <a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a>.</p>
<a name="diagramtextitem-implementation"></a>
<h4 id="diagramtextitem-implementation">DiagramTextItem Implementation<a class="plink" href="#diagramtextitem-implementation" title="Direct link to this headline"></a></h4>
<p>We start with the constructor:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">DiagramTextItem<span class="operator">::</span>DiagramTextItem(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>parent)
    : <span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span>(parent)
{
    setFlag(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemIsMovable);
    setFlag(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemIsSelectable);
}</pre></div>
<p>We simply set the item movable and selectable, as these flags are off by default.</p>
<p>Here is the <code translate="no">itemChange()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> DiagramTextItem<span class="operator">::</span>itemChange(GraphicsItemChange change<span class="operator">,</span>
                     <span class="keyword">const</span> <span class="type"><a href="./qvariant.htm" translate="no">QVariant</a></span> <span class="operator">&amp;</span>value)
{
    <span class="keyword">if</span> (change <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemSelectedHasChanged)
        <span class="keyword">emit</span> selectedChange(<span class="keyword">this</span>);
    <span class="keyword">return</span> value;
}</pre></div>
<p>When the item is selected we emit the selectedChanged signal. The <code translate="no">MainWindow</code> uses this signal to update the widgets that display font properties to the font of the selected text item.</p>
<p>Here is the <code translate="no">focusOutEvent()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramTextItem<span class="operator">::</span>focusOutEvent(<span class="type"><a href="./qfocusevent.htm" translate="no">QFocusEvent</a></span> <span class="operator">*</span>event)
{
    setTextInteractionFlags(<span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>NoTextInteraction);
    <span class="keyword">emit</span> lostFocus(<span class="keyword">this</span>);
    <span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span><span class="operator">::</span>focusOutEvent(event);
}</pre></div>
<p><code translate="no">DiagramScene</code> uses the signal emitted when the text item loses focus to remove the item if it is empty, i.e., it contains no text.</p>
<p>This is the implementation of <code translate="no">mouseDoubleClickEvent()</code>:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> DiagramTextItem<span class="operator">::</span>mouseDoubleClickEvent(<span class="type"><a href="./qgraphicsscenemouseevent.htm" translate="no">QGraphicsSceneMouseEvent</a></span> <span class="operator">*</span>event)
{
    <span class="keyword">if</span> (textInteractionFlags() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>NoTextInteraction)
        setTextInteractionFlags(<span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>TextEditorInteraction);
    <span class="type"><a href="./qgraphicstextitem.htm" translate="no">QGraphicsTextItem</a></span><span class="operator">::</span>mouseDoubleClickEvent(event);
}</pre></div>
<p>When we receive a double click event, we make the item editable by calling <a href="./qgraphicstextitem.htm#setTextInteractionFlags" translate="no">QGraphicsTextItem::setTextInteractionFlags</a>(). We then forward the double-click to the item itself.</p>
<a name="arrow-class-definition"></a>
<h4 id="arrow-class-definition">Arrow Class Definition<a class="plink" href="#arrow-class-definition" title="Direct link to this headline"></a></h4>
<p>The <code translate="no">Arrow</code> class is a graphics item that connects two <code translate="no">DiagramItems</code>. It draws an arrow head to one of the items. To achieve this the item needs to paint itself and also re implement methods used by the graphics scene to check for collisions and selections. The class inherits QGraphicsLine item, and draws the arrowhead and moves with the items it connects.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="keyword">class</span> Arrow : <span class="keyword">public</span> <span class="type"><a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a></span>
{
<span class="keyword">public</span>:
    <span class="keyword">enum</span> { Type <span class="operator">=</span> UserType <span class="operator">+</span> <span class="number">4</span> };

    Arrow(DiagramItem <span class="operator">*</span>startItem<span class="operator">,</span> DiagramItem <span class="operator">*</span>endItem<span class="operator">,</span>
          <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);

    <span class="type">int</span> type() <span class="keyword">const</span> override { <span class="keyword">return</span> Type; }
    <span class="type"><a href="./qrectf.htm" translate="no">QRectF</a></span> boundingRect() <span class="keyword">const</span> override;
    <span class="type"><a href="./qpainterpath.htm" translate="no">QPainterPath</a></span> shape() <span class="keyword">const</span> override;
    <span class="type">void</span> setColor(<span class="keyword">const</span> <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> <span class="operator">&amp;</span>color) { myColor <span class="operator">=</span> color; }
    DiagramItem <span class="operator">*</span>startItem() <span class="keyword">const</span> { <span class="keyword">return</span> myStartItem; }
    DiagramItem <span class="operator">*</span>endItem() <span class="keyword">const</span> { <span class="keyword">return</span> myEndItem; }

    <span class="type">void</span> updatePosition();

<span class="keyword">protected</span>:
    <span class="type">void</span> paint(<span class="type"><a href="./qpainter.htm" translate="no">QPainter</a></span> <span class="operator">*</span>painter<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="./qstyleoptiongraphicsitem.htm" translate="no">QStyleOptionGraphicsItem</a></span> <span class="operator">*</span>option<span class="operator">,</span>
               <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>widget <span class="operator">=</span> nullptr) override;

<span class="keyword">private</span>:
    DiagramItem <span class="operator">*</span>myStartItem;
    DiagramItem <span class="operator">*</span>myEndItem;
    <span class="type"><a href="./qpolygonf.htm" translate="no">QPolygonF</a></span> arrowHead;
    <span class="type"><a href="./qcolor.htm" translate="no">QColor</a></span> myColor <span class="operator">=</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>black;
};</pre></div>
<p>The item's color can be set with <code translate="no">setColor()</code>.</p>
<p><code translate="no">boundingRect()</code> and <code translate="no">shape()</code> are reimplemented from <a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a> and are used by the scene to check for collisions and selections.</p>
<p>Calling <code translate="no">updatePosition()</code> causes the arrow to recalculate its position and arrow head angle. <code translate="no">paint()</code> is reimplemented so that we can paint an arrow rather than just a line between items.</p>
<p><code translate="no">myStartItem</code> and <code translate="no">myEndItem</code> are the diagram items that the arrow connects. The arrow is drawn with its head to the end item. <code translate="no">arrowHead</code> is a polygon with three vertices's we use to draw the arrow head.</p>
<a name="arrow-class-implementation"></a>
<h4 id="arrow-class-implementation">Arrow Class Implementation<a class="plink" href="#arrow-class-implementation" title="Direct link to this headline"></a></h4>
<p>The constructor of the <code translate="no">Arrow</code> class looks like this:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">Arrow<span class="operator">::</span>Arrow(DiagramItem <span class="operator">*</span>startItem<span class="operator">,</span> DiagramItem <span class="operator">*</span>endItem<span class="operator">,</span> <span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span> <span class="operator">*</span>parent)
    : <span class="type"><a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a></span>(parent)<span class="operator">,</span> myStartItem(startItem)<span class="operator">,</span> myEndItem(endItem)
{
    setFlag(<span class="type"><a href="./qgraphicsitem.htm" translate="no">QGraphicsItem</a></span><span class="operator">::</span>ItemIsSelectable<span class="operator">,</span> <span class="keyword">true</span>);
    setPen(<span class="type"><a href="./qpen.htm" translate="no">QPen</a></span>(myColor<span class="operator">,</span> <span class="number">2</span><span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>SolidLine<span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>RoundCap<span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>RoundJoin));
}</pre></div>
<p>We set the start and end diagram items of the arrow. The arrow head will be drawn where the line intersects the end item.</p>
<p>Here is the <code translate="no">boundingRect()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qrectf.htm" translate="no">QRectF</a></span> Arrow<span class="operator">::</span>boundingRect() <span class="keyword">const</span>
{
    <span class="type"><a href="./qtglobal.htm#qreal-typedef" translate="no">qreal</a></span> extra <span class="operator">=</span> (pen()<span class="operator">.</span>width() <span class="operator">+</span> <span class="number">20</span>) <span class="operator">/</span> <span class="number">2.0</span>;

    <span class="keyword">return</span> <span class="type"><a href="./qrectf.htm" translate="no">QRectF</a></span>(line()<span class="operator">.</span>p1()<span class="operator">,</span> <span class="type"><a href="./qsizef.htm" translate="no">QSizeF</a></span>(line()<span class="operator">.</span>p2()<span class="operator">.</span>x() <span class="operator">-</span> line()<span class="operator">.</span>p1()<span class="operator">.</span>x()<span class="operator">,</span>
                                      line()<span class="operator">.</span>p2()<span class="operator">.</span>y() <span class="operator">-</span> line()<span class="operator">.</span>p1()<span class="operator">.</span>y()))
        <span class="operator">.</span>normalized()
        <span class="operator">.</span>adjusted(<span class="operator">-</span>extra<span class="operator">,</span> <span class="operator">-</span>extra<span class="operator">,</span> extra<span class="operator">,</span> extra);
}</pre></div>
<p>We need to reimplement this function because the arrow is larger than the bounding rectangle of the <a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a>. The graphics scene uses the bounding rectangle to know which regions of the scene to update.</p>
<p>Here is the <code translate="no">shape()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type"><a href="./qpainterpath.htm" translate="no">QPainterPath</a></span> Arrow<span class="operator">::</span>shape() <span class="keyword">const</span>
{
    <span class="type"><a href="./qpainterpath.htm" translate="no">QPainterPath</a></span> path <span class="operator">=</span> <span class="type"><a href="./qgraphicslineitem.htm" translate="no">QGraphicsLineItem</a></span><span class="operator">::</span>shape();
    path<span class="operator">.</span>addPolygon(arrowHead);
    <span class="keyword">return</span> path;
}</pre></div>
<p>The shape function returns a <a href="./qpainterpath.htm" translate="no">QPainterPath</a> that is the exact shape of the item. The <a href="./qgraphicslineitem.htm#shape" translate="no">QGraphicsLineItem::shape</a>() returns a path with a line drawn with the current pen, so we only need to add the arrow head. This function is used to check for collisions and selections with the mouse.</p>
<p>Here is the <code translate="no">updatePosition()</code> slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> Arrow<span class="operator">::</span>updatePosition()
{
    <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span> line(mapFromItem(myStartItem<span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">0</span>)<span class="operator">,</span> mapFromItem(myEndItem<span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">0</span>));
    setLine(line);
}</pre></div>
<p>This slot updates the arrow by setting the start and end points of its line to the center of the items it connects.</p>
<p>Here is the <code translate="no">paint()</code> function:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> Arrow<span class="operator">::</span>paint(<span class="type"><a href="./qpainter.htm" translate="no">QPainter</a></span> <span class="operator">*</span>painter<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="./qstyleoptiongraphicsitem.htm" translate="no">QStyleOptionGraphicsItem</a></span> <span class="operator">*</span><span class="operator">,</span>
                  <span class="type"><a href="./qwidget.htm" translate="no">QWidget</a></span> <span class="operator">*</span>)
{
    <span class="keyword">if</span> (myStartItem<span class="operator">-</span><span class="operator">&gt;</span>collidesWithItem(myEndItem))
        <span class="keyword">return</span>;

    <span class="type"><a href="./qpen.htm" translate="no">QPen</a></span> myPen <span class="operator">=</span> pen();
    myPen<span class="operator">.</span>setColor(myColor);
    <span class="type"><a href="./qtglobal.htm#qreal-typedef" translate="no">qreal</a></span> arrowSize <span class="operator">=</span> <span class="number">20</span>;
    painter<span class="operator">-</span><span class="operator">&gt;</span>setPen(myPen);
    painter<span class="operator">-</span><span class="operator">&gt;</span>setBrush(myColor);</pre></div>
<p>If the start and end items collide we do not draw the arrow; the algorithm we use to find the point the arrow should be drawn at may fail if the items collide.</p>
<p>We first set the pen and brush we will use for drawing the arrow.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span> centerLine(myStartItem<span class="operator">-</span><span class="operator">&gt;</span>pos()<span class="operator">,</span> myEndItem<span class="operator">-</span><span class="operator">&gt;</span>pos());
    <span class="type"><a href="./qpolygonf.htm" translate="no">QPolygonF</a></span> endPolygon <span class="operator">=</span> myEndItem<span class="operator">-</span><span class="operator">&gt;</span>polygon();
    <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span> p1 <span class="operator">=</span> endPolygon<span class="operator">.</span>first() <span class="operator">+</span> myEndItem<span class="operator">-</span><span class="operator">&gt;</span>pos();
    <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span> intersectPoint;
    <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">1</span>; i <span class="operator">&lt;</span> endPolygon<span class="operator">.</span>count(); <span class="operator">+</span><span class="operator">+</span>i) {
        <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span> p2 <span class="operator">=</span> endPolygon<span class="operator">.</span>at(i) <span class="operator">+</span> myEndItem<span class="operator">-</span><span class="operator">&gt;</span>pos();
        <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span> polyLine <span class="operator">=</span> <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span>(p1<span class="operator">,</span> p2);
        <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span><span class="operator">::</span>IntersectionType intersectionType <span class="operator">=</span>
            polyLine<span class="operator">.</span>intersects(centerLine<span class="operator">,</span> <span class="operator">&amp;</span>intersectPoint);
        <span class="keyword">if</span> (intersectionType <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span><span class="operator">::</span>BoundedIntersection)
            <span class="keyword">break</span>;
        p1 <span class="operator">=</span> p2;
    }

    setLine(<span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span>(intersectPoint<span class="operator">,</span> myStartItem<span class="operator">-</span><span class="operator">&gt;</span>pos()));</pre></div>
<p>We then need to find the position at which to draw the arrowhead. The head should be drawn where the line and the end item intersects. This is done by taking the line between each point in the polygon and check if it intersects with the line of the arrow. Since the line start and end points are set to the center of the items the arrow line should intersect one and only one of the lines of the polygon. Note that the points in the polygon are relative to the local coordinate system of the item. We must therefore add the position of the end item to make the coordinates relative to the scene.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    <span class="type">double</span> angle <span class="operator">=</span> std<span class="operator">::</span>atan2(<span class="operator">-</span>line()<span class="operator">.</span>dy()<span class="operator">,</span> line()<span class="operator">.</span>dx());

    <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span> arrowP1 <span class="operator">=</span> line()<span class="operator">.</span>p1() <span class="operator">+</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(sin(angle <span class="operator">+</span> M_PI <span class="operator">/</span> <span class="number">3</span>) <span class="operator">*</span> arrowSize<span class="operator">,</span>
                                    cos(angle <span class="operator">+</span> M_PI <span class="operator">/</span> <span class="number">3</span>) <span class="operator">*</span> arrowSize);
    <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span> arrowP2 <span class="operator">=</span> line()<span class="operator">.</span>p1() <span class="operator">+</span> <span class="type"><a href="./qpointf.htm" translate="no">QPointF</a></span>(sin(angle <span class="operator">+</span> M_PI <span class="operator">-</span> M_PI <span class="operator">/</span> <span class="number">3</span>) <span class="operator">*</span> arrowSize<span class="operator">,</span>
                                    cos(angle <span class="operator">+</span> M_PI <span class="operator">-</span> M_PI <span class="operator">/</span> <span class="number">3</span>) <span class="operator">*</span> arrowSize);

    arrowHead<span class="operator">.</span>clear();
    arrowHead <span class="operator">&lt;</span><span class="operator">&lt;</span> line()<span class="operator">.</span>p1() <span class="operator">&lt;</span><span class="operator">&lt;</span> arrowP1 <span class="operator">&lt;</span><span class="operator">&lt;</span> arrowP2;</pre></div>
<p>We calculate the angle between the x-axis and the line of the arrow. We need to turn the arrow head to this angle so that it follows the direction of the arrow. If the angle is negative we must turn the direction of the arrow.</p>
<p>We can then calculate the three points of the arrow head polygon. One of the points is the end of the line, which now is the intersection between the arrow line and the end polygon. Then we clear the <code translate="no">arrowHead</code> polygon from the previous calculated arrow head and set these new points.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    painter<span class="operator">-</span><span class="operator">&gt;</span>drawLine(line());
    painter<span class="operator">-</span><span class="operator">&gt;</span>drawPolygon(arrowHead);
    <span class="keyword">if</span> (isSelected()) {
        painter<span class="operator">-</span><span class="operator">&gt;</span>setPen(<span class="type"><a href="./qpen.htm" translate="no">QPen</a></span>(myColor<span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> <span class="type"><a href="./qt.htm" translate="no">Qt</a></span><span class="operator">::</span>DashLine));
        <span class="type"><a href="./qlinef.htm" translate="no">QLineF</a></span> myLine <span class="operator">=</span> line();
        myLine<span class="operator">.</span>translate(<span class="number">0</span><span class="operator">,</span> <span class="number">4.0</span>);
        painter<span class="operator">-</span><span class="operator">&gt;</span>drawLine(myLine);
        myLine<span class="operator">.</span>translate(<span class="number">0</span><span class="operator">,</span><span class="operator">-</span><span class="number">8.0</span>);
        painter<span class="operator">-</span><span class="operator">&gt;</span>drawLine(myLine);
    }
}</pre></div>
<p>If the line is selected, we draw two dotted lines that are parallel with the line of the arrow. We do not use the default implementation, which uses <a href="./qgraphicsitem.htm#boundingRect" translate="no">boundingRect()</a> because the <a href="./qrect.htm" translate="no">QRect</a> bounding rectangle is considerably larger than the line.</p>
<p><a href="https://code.qt.io/cgit/qt/qtbase.git/tree/examples/widgets/graphicsview/diagramscene?h=5.15" translate="no">Example project @ code.qt.io</a></p>
</div>
<!-- @@@graphicsview/diagramscene -->
</div>
<p class="copy-notice">
<acronym title="Copyright"></acronym> 2025 The Qt Company Ltd.
   Documentation contributions included herein are the copyrights of
   their respective owners.     The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the Free Software Foundation.     Qt and respective logos are <a href="https://doc.qt.io/qt/trademarks.html">    trademarks</a> of The Qt Company Ltd. in Finland and/or other countries
   worldwide. All other trademarks are property of their respective owners. </p>

                    </div>
                </article>
                
            </div>
        </div>
    </div>
</div>
</body></html>