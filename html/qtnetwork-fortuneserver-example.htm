<html lang="en"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fortune Server Example | Qt Network</title>
<link rel="canonical" href="https://doc.qt.io/qt-6/qtnetwork-fortuneserver-example.html">
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <!-- Google Tag Manager -->
    
  <!-- End Google Tag Manager -->
  
  
</head>
<body class="qt-design-system" style="background:var(--content-bg-color)" onload="prettyPrint()">

<div data-global-resource-path="qt-design-system/components/b-sidebar.html">
    <div class="b-sidebar b-sidebar--full-width">
        
        <div class="b-sidebar__content">
            <div class="b-sidebar__topbar" data-margin-bottom="sm">
                <div class="b-topbar">
                                        <div class="b-topbar__breadcrump" translate="no">
                        <ul class="c-breadcrump">
                            <li><a href="./index.htm" translate="no">Qt 5.15</a></li>
                            <li><a href="./qtnetwork-index.htm" translate="no">Qt Network</a></li>
                            <li><a href="./examples-network.htm" translate="no">Network Examples</a></li>
                            <li><a>Fortune Server Example</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="b-sidebar__content__wrapper">
                <article class="b-sidebar__content__left">
                    <div class="context mainContent" style="margin: 0;padding: 0; background: 0;">
                    

<div class="context">
<h1 class="title">Fortune Server Example</h1>
<span class="subtitle"></span>
<!-- $$$fortuneserver-brief -->
<p>Demonstrates how to create a server for a network service.</p>
<!-- @@@fortuneserver -->
<!-- $$$fortuneserver-description -->
<div class="descr"> <a name="details"></a>
<p>This example is intended to be run alongside the <a href="./qtnetwork-fortuneclient-example.htm" translate="no">Fortune Client</a> example or the <a href="./qtnetwork-blockingfortuneclient-example.htm" translate="no">Blocking Fortune Client Example</a>.</p>
<p class="centerAlign"><img alt="Screenshot of the Fortune Server example" src="./images/fortuneserver-example.png"></p><p>It uses <a href="./qtcpserver.htm" translate="no">QTcpServer</a> to accept incoming TCP connections, and a simple <a href="./qdatastream.htm" translate="no">QDataStream</a> based data transfer protocol to write a fortune to the connecting client (from the <a href="./qtnetwork-fortuneclient-example.htm" translate="no">Fortune Client</a> example), before closing the connection.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="keyword">class</span> Server : <span class="keyword">public</span> <span class="type">QDialog</span>
{
    Q_OBJECT

<span class="keyword">public</span>:
    <span class="keyword">explicit</span> Server(<span class="type">QWidget</span> <span class="operator">*</span>parent <span class="operator">=</span> nullptr);

<span class="keyword">private</span> <span class="keyword">slots</span>:
    <span class="type">void</span> sendFortune();

<span class="keyword">private</span>:
    <span class="type">void</span> initServer();

    <span class="type">QLabel</span> <span class="operator">*</span>statusLabel <span class="operator">=</span> nullptr;
    <span class="type"><a href="./qtcpserver.htm" translate="no">QTcpServer</a></span> <span class="operator">*</span>tcpServer <span class="operator">=</span> nullptr;
    <span class="type"><a href="./qvector.htm" translate="no">QVector</a></span><span class="operator">&lt;</span><span class="type"><a href="./qstring.htm" translate="no">QString</a></span><span class="operator">&gt;</span> fortunes;
};</pre></div>
<p>The server is implemented using a simple class with only one slot, for handling incoming connections.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    tcpServer <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="./qtcpserver.htm" translate="no">QTcpServer</a></span>(<span class="keyword">this</span>);
    <span class="keyword">if</span> (<span class="operator">!</span>tcpServer<span class="operator">-</span><span class="operator">&gt;</span>listen()) {
        <span class="type">QMessageBox</span><span class="operator">::</span>critical(<span class="keyword">this</span><span class="operator">,</span> tr(<span class="string">"Fortune Server"</span>)<span class="operator">,</span>
                              tr(<span class="string">"Unable to start the server: %1."</span>)
                              <span class="operator">.</span>arg(tcpServer<span class="operator">-</span><span class="operator">&gt;</span>errorString()));
        close();
        <span class="keyword">return</span>;
    }
    <span class="type"><a href="./qstring.htm" translate="no">QString</a></span> ipAddress;
    <span class="type"><a href="./qlist.htm" translate="no">QList</a></span><span class="operator">&lt;</span><span class="type"><a href="./qhostaddress.htm" translate="no">QHostAddress</a></span><span class="operator">&gt;</span> ipAddressesList <span class="operator">=</span> <span class="type"><a href="./qnetworkinterface.htm" translate="no">QNetworkInterface</a></span><span class="operator">::</span>allAddresses();
    <span class="comment">// use the first non-localhost IPv4 address</span>
    <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> ipAddressesList<span class="operator">.</span>size(); <span class="operator">+</span><span class="operator">+</span>i) {
        <span class="keyword">if</span> (ipAddressesList<span class="operator">.</span>at(i) <span class="operator">!</span><span class="operator">=</span> <span class="type"><a href="./qhostaddress.htm" translate="no">QHostAddress</a></span><span class="operator">::</span>LocalHost <span class="operator">&amp;</span><span class="operator">&amp;</span>
            ipAddressesList<span class="operator">.</span>at(i)<span class="operator">.</span>toIPv4Address()) {
            ipAddress <span class="operator">=</span> ipAddressesList<span class="operator">.</span>at(i)<span class="operator">.</span>toString();
            <span class="keyword">break</span>;
        }
    }
    <span class="comment">// if we did not find one, use IPv4 localhost</span>
    <span class="keyword">if</span> (ipAddress<span class="operator">.</span>isEmpty())
        ipAddress <span class="operator">=</span> <span class="type"><a href="./qhostaddress.htm" translate="no">QHostAddress</a></span>(<span class="type"><a href="./qhostaddress.htm" translate="no">QHostAddress</a></span><span class="operator">::</span>LocalHost)<span class="operator">.</span>toString();
    statusLabel<span class="operator">-</span><span class="operator">&gt;</span>setText(tr(<span class="string">"The server is running on\n\nIP: %1\nport: %2\n\n"</span>
                            <span class="string">"Run the Fortune Client example now."</span>)
                         <span class="operator">.</span>arg(ipAddress)<span class="operator">.</span>arg(tcpServer<span class="operator">-</span><span class="operator">&gt;</span>serverPort()));</pre></div>
<p>In its constructor, our Server object calls <a href="./qtcpserver.htm#listen" translate="no">QTcpServer::listen</a>() to set up a <a href="./qtcpserver.htm" translate="no">QTcpServer</a> to listen on all addresses, on an arbitrary port. In then displays the port <a href="./qtcpserver.htm" translate="no">QTcpServer</a> picked in a label, so that user knows which port the fortune client should connect to.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">fortunes <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"You've been leading a dog's life. Stay off the furniture."</span>)
         <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"You've got to think about tomorrow."</span>)
         <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"You will be surprised by a loud noise."</span>)
         <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"You will feel hungry again in another hour."</span>)
         <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"You might have mail."</span>)
         <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"You cannot kill time without injuring eternity."</span>)
         <span class="operator">&lt;</span><span class="operator">&lt;</span> tr(<span class="string">"Computers are not intelligent. They only think they are."</span>);</pre></div>
<p>Our server generates a list of random fortunes that it can send to connecting clients.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">connect(tcpServer<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="./qtcpserver.htm" translate="no">QTcpServer</a></span><span class="operator">::</span>newConnection<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> <span class="operator">&amp;</span>Server<span class="operator">::</span>sendFortune);</pre></div>
<p>When a client connects to our server, <a href="./qtcpserver.htm" translate="no">QTcpServer</a> will emit <a href="./qtcpserver.htm#newConnection" translate="no">QTcpServer::newConnection</a>(). In turn, this will invoke our sendFortune() slot:</p>
<div class="pre"><pre class="cpp prettyprint" translate="no"><span class="type">void</span> Server<span class="operator">::</span>sendFortune()
{
    <span class="type"><a href="./qbytearray.htm" translate="no">QByteArray</a></span> block;
    <span class="type"><a href="./qdatastream.htm" translate="no">QDataStream</a></span> out(<span class="operator">&amp;</span>block<span class="operator">,</span> <span class="type"><a href="./qiodevice.htm" translate="no">QIODevice</a></span><span class="operator">::</span>WriteOnly);
    out<span class="operator">.</span>setVersion(<span class="type"><a href="./qdatastream.htm" translate="no">QDataStream</a></span><span class="operator">::</span>Qt_5_10);

    out <span class="operator">&lt;</span><span class="operator">&lt;</span> fortunes<span class="operator">[</span><span class="type"><a href="./qrandomgenerator.htm" translate="no">QRandomGenerator</a></span><span class="operator">::</span>global()<span class="operator">-</span><span class="operator">&gt;</span>bounded(fortunes<span class="operator">.</span>size())<span class="operator">]</span>;</pre></div>
<p>The purpose of this slot is to select a random line from our list of fortunes, encode it into a <a href="./qbytearray.htm" translate="no">QByteArray</a> using <a href="./qdatastream.htm" translate="no">QDataStream</a>, and then write it to the connecting socket. This is a common way to transfer binary data using <a href="./qtcpsocket.htm" translate="no">QTcpSocket</a>. First we create a <a href="./qbytearray.htm" translate="no">QByteArray</a> and a <a href="./qdatastream.htm" translate="no">QDataStream</a> object, passing the bytearray to <a href="./qdatastream.htm" translate="no">QDataStream</a>'s constructor. We then explicitly set the protocol version of <a href="./qdatastream.htm" translate="no">QDataStream</a> to <a href="./qdatastream.htm#Version-enum" translate="no">QDataStream::Qt_4_0</a> to ensure that we can communicate with clients from future versions of Qt (see <a href="./qdatastream.htm#setVersion" translate="no">QDataStream::setVersion</a>()). We continue by streaming in a random fortune.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    <span class="type"><a href="./qtcpsocket.htm" translate="no">QTcpSocket</a></span> <span class="operator">*</span>clientConnection <span class="operator">=</span> tcpServer<span class="operator">-</span><span class="operator">&gt;</span>nextPendingConnection();
    connect(clientConnection<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="./qabstractsocket.htm" translate="no">QAbstractSocket</a></span><span class="operator">::</span>disconnected<span class="operator">,</span>
            clientConnection<span class="operator">,</span> <span class="operator">&amp;</span><span class="type"><a href="./qobject.htm" translate="no">QObject</a></span><span class="operator">::</span>deleteLater);</pre></div>
<p>We then call <a href="./qtcpserver.htm#nextPendingConnection" translate="no">QTcpServer::nextPendingConnection</a>(), which returns the <a href="./qtcpsocket.htm" translate="no">QTcpSocket</a> representing the server side of the connection. By connecting <a href="./qabstractsocket.htm#disconnected" translate="no">QTcpSocket::disconnected</a>() to <a href="./qobject.htm#deleteLater" translate="no">QObject::deleteLater</a>(), we ensure that the socket will be deleted after disconnecting.</p>
<div class="pre"><pre class="cpp prettyprint" translate="no">    clientConnection<span class="operator">-</span><span class="operator">&gt;</span>write(block);
    clientConnection<span class="operator">-</span><span class="operator">&gt;</span>disconnectFromHost();
}</pre></div>
<p>The encoded fortune is written using <a href="./qiodevice.htm#write" translate="no">QTcpSocket::write</a>(), and we finally call <a href="./qabstractsocket.htm#disconnectFromHost" translate="no">QTcpSocket::disconnectFromHost</a>(), which will close the connection after <a href="./qtcpsocket.htm" translate="no">QTcpSocket</a> has finished writing the fortune to the network. Because <a href="./qtcpsocket.htm" translate="no">QTcpSocket</a> works asynchronously, the data will be written after this function returns, and control goes back to Qt's event loop. The socket will then close, which in turn will cause <a href="./qobject.htm#deleteLater" translate="no">QObject::deleteLater</a>() to delete it.</p>
<p><a href="https://code.qt.io/cgit/qt/qtbase.git/tree/examples/network/fortuneserver?h=5.15" translate="no">Example project @ code.qt.io</a></p>
</div>
<p><b>See also </b><a href="./qtnetwork-fortuneclient-example.htm" translate="no">Fortune Client Example</a> and <a href="./qtnetwork-threadedfortuneserver-example.htm" translate="no">Threaded Fortune Server Example</a>.</p>
<!-- @@@fortuneserver -->
</div>
<p class="copy-notice">
<acronym title="Copyright">Â©</acronym> 2025 The Qt Company Ltd.
   Documentation contributions included herein are the copyrights of
   their respective owners.     The documentation provided herein is licensed under the terms of the    <a href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation    License version 1.3</a> as published by the Free Software Foundation.     Qt and respective logos are <a href="https://doc.qt.io/qt/trademarks.html">    trademarks</a> of The Qt Company Ltd. in Finland and/or other countries
   worldwide. All other trademarks are property of their respective owners. </p>

                    </div>
                </article>
                
            </div>
        </div>
    </div>
</div>
</body></html>